# 启动引导程序

- `bootsect.s` / 主引导扇区代码，主要用于加载 `setup` 和内核 `system`

## BIOS int 0x13

- AH = 0 / 重置磁盘
- AH = 2 / 以 CHS 模式读磁盘
- AH = 3 / 以 CHS 模式写磁盘
- AH = 0x15 / 检测第二磁盘
- AH = 0x41 / 测试扩展功能
- AH = 0x42 / 如果支持扩展功能，则以 LBA 模式读磁盘
- AH = 0x43 / 如果支持扩展功能，则以 LBA 模式写磁盘

### 重置磁盘

参数：

1. AH = 0 : 表示重置磁盘驱动器
2. DL = 驱动器号，如果是硬盘则位 7 要置位

返回值：

1. 如果出错，CF = 1

### 以 CHS 模式读取软盘

参数：

1. 设置 AH = 2：表示需要读磁盘
2. AL = 需要读取的数量，
   - 不能超过 es 64K 界限（由于只能使用 BX 访问 64K）
   - 或者柱面界限（由于需要重新寻道），
   - 必须 < 128 (128 * 512 = 64K，最多访问 64KB的空间)
3. CH = 柱面号的低 8 位
4. CL 
    - 0 - 5 位：开始的扇区
    - 6 - 7 位：柱面号的高2位
5. DH = 磁头号
6. DL = 驱动器号，如果是硬盘则位 7 要置位
7. ES:BX -> 读入的内存缓冲区
8. `int 0x13`

返回值

1. 如果出错，CF = 1

```s
read_mbr:
    ; 读取主引导扇区

    ; 缓冲区位 es:bx = 0x10000
    mov ax, 0x1000
    mov es, ax
    mov bx, 0

    mov ah, 2; 表示读磁盘
    mov al, 1; 读取一个扇区
    mov ch, 0; 磁道号 0 
    mov cl, 1; 第一个扇区，注意扇区号从 1 开始
    mov dh, 0; 第 0 个磁头（盘面）
    mov dl, 0; 驱动器号 0 
    int 0x13
    jnc .success
.error:
    ; 读取失败
    jmp .error
.success:
    ; 此时读取成功
    xchg bx, bx
```

> 注：如果要写磁盘，设置 AH = 3 即可，整个过程就是将缓存区 `ES:BX` 的内容写入磁盘。

比如将刚才读入的数据稍微改改，再回去

```s
    mov word es:[508], 0x1122
    mov bx, 0

    mov ah, 3; 表示写磁盘
    mov al, 1; 写一个扇区
    mov ch, 0; 磁道号 0 
    mov cl, 1; 第一个扇区，注意扇区号从 1 开始
    mov dh, 0; 第 0 个磁头（盘面）
    mov dl, 0; 驱动器号 0 
    int 0x13
```

## BIOS int 0x10

- AH = 1 / 设置光标类型
- AH = 2 / 设置光标位置
- AH = 3 / 获取光标位置
- AH = 0xE / 显示字符
- AH = 0xF / 获取当前状态
- AH = 0x11 / 字符生成器
- AH = 0x12 / 检测 EGA/VGA
- AH = 0x13 / 显示字符串

### 获取光标位置

参数：

- AH = 3 : 表示获取光标位置
- BH: 页数以 0 开始

返回值：

- (DH, DL): (行, 列) 请求页的位置
- (CH, CL): 当前光标类型

### 打印字符串

参数：

- AH = 0x13：表示打印字符串
- ES:BP -> 指向需要打印字符串的内存
- CX: 需要打印的字符数量
- DX: 字符串开始的光标位置，一般获取光标位置得到
- BH: 页码
- BL: 字符样式
- AL
    - 00: 不移动光标
    - 01: 移动光标

没有返回值

## 参考资料

- Linux 内核源码漫游  
    <http://oldlinux.org/Linux.old/docs/Linux%C4%DA%BA%CB%D4%B4%B4%FA%C2%EB%C2%FE%D3%CE.pdf>
- https://wiki.osdev.org/ATA_in_x86_RealMode_(BIOS)  
- IBM PS 2 and PC BIOS Interface Technical Reference  
