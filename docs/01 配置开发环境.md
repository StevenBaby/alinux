# 配置开发环境

## bochs-gdb

如果已经配置了 `bochs-gdb` 可以首先在 主机上执行 `make bochsg`，此时，bochs-gdb 会处于等待连接的状态。

然后在 vscode 中点击 `F5`，开始对内核的单步调试。

### Archlinux 的安装方法

可在 `devel/bochs-gdb` 目录直接执行命令:

    makepkg -si

安装完成之后，就会有 `bochs-gdb` 命令。

---

注：默认 bochs 模拟时，会在 PageFault 的情况下中断，所以使用 `SIGUSR2` 来替代默认的信号 0。

我当前 gdb 的版本是 10.1，通过研究 gdb 源码找到了 `SIGUSR2` 定义的数字是 `31`，定义在文件 `/gdb/alpha-linux-tdep.c` 中的枚举 `ALPHA_LINUX_SIGUSR2 = 31`，这个与 bochs 源码中定义的有所不同，不过目前看起来一切运行良好。

`fix-build.patch` 经过了优化，去掉了 PageFault 信号在 gdb 中引起的中断；不过首先需要在 gdb 中执行：

    [-exec] handle SIGUSR2 nostop noprint nopass

其中 `-exec` 是 vscode 中的必要选项，也可以在 vscode `launch.json` 文件 setupCommands 中加入下面的内容：

```json
{
    "description": "ignore SIGUSR2 signal",
    "text": "handle SIGUSR2 nostop noprint nopass"
}
```

目前不知道这样做的其他后果，对于 gdb 的调试功能还不是很清楚，这里需要做进一步研究。

---

## 关于 hda.img 的处理

由于实现提交了 根文件系统 `hda.img`，但是开发调试的过程中会改动 hda.img，但是我又不想再提交这个文件，于是可以执行下面的命令来再 `git commit` 时去掉该文件。

    git update-index --no-assume-unchanged hda.img

## 参考资料

- <https://stackoverflow.com/questions/7527982/applying-gitignore-to-committed-files>
- bochs与gdb联调时忽略 page fault 信号  
    <https://ultraji.xyz/2019/03/bochs_gdb_page_fault.html>
- diff & patch 制作及打补丁  
    <https://blog.csdn.net/u011784994/article/details/52944636>
