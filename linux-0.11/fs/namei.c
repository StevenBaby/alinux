/*
 *  linux/fs/namei.c
 *
 *  (C) 1991  Linus Torvalds
 */

// [è¯¥æ–‡ä»¶æ˜¯ linux 0.11 å†…æ ¸ä¸­æœ€é•¿ï¼Œæˆ‘è¦æ·¦äº†ï¼ï¼ï¼ğŸ˜Š 2021-09-03]

// tytso ä½œäº†ä¸€äº›çº æ­£

#include <linux/sched.h>
#include <linux/kernel.h>
#include <asm/segment.h>

#include <string.h>
#include <fcntl.h>
#include <errno.h>
#include <const.h>
#include <sys/stat.h>

// è®¿é—®æ¨¡å¼å®
// x æ˜¯ include/fcntl.h ä¸­å®šä¹‰çš„æ–‡ä»¶è®¿é—®æ ‡å¿—
// æ ¹æ® x å€¼ç´¢å¼•å¯¹åº”æ•°å€¼ï¼ˆæ•°å€¼è¡¨ç¤ºrwx æƒé™: r, w, rw, wxrwxrwxï¼‰(æ•°å€¼æ˜¯ 8 è¿›åˆ¶)
#define ACC_MODE(x) ("\004\002\006\377"[(x)&O_ACCMODE])

// å¦‚æœæƒ³è®©æ–‡ä»¶åé•¿åº¦ > NAME_LEN çš„å­—ç¬¦è¢«æˆªæ‰ï¼Œå°±å°†ä¸‹é¢å®šä¹‰æ³¨é‡Šæ‰

/* #define NO_TRUNCATE */

#define MAY_EXEC 1
#define MAY_WRITE 2
#define MAY_READ 4

// permission()
// è¯¥å‡½æ•°ç”¨äºæ£€æµ‹ä¸€ä¸ªæ–‡ä»¶çš„è¯»/å†™/æ‰§è¡Œæƒé™
// æˆ‘ä¸çŸ¥é“æ˜¯å¦åªéœ€æ£€æŸ¥ euidï¼Œè¿˜æ˜¯éœ€è¦æ£€æŸ¥ euid å’Œ uid ä¸¤è€…ï¼Œä¸è¿‡è¿™å¾ˆå®¹æ˜“ä¿®æ”¹

// æ£€æµ‹æ–‡ä»¶è®¿é—®è®¸å¯æƒé™
// å‚æ•°ï¼š
// inode - æ–‡ä»¶å¯¹åº”çš„ i èŠ‚ç‚¹ï¼›
// mask - è®¿é—®å±æ€§å±è”½ç ï¼›
// è¿”å›ï¼šè®¿é—®è®¸å¯è¿”å› 1ï¼Œå¦åˆ™è¿”å› 0
static int permission(struct m_inode *inode, int mask)
{
	// æ–‡ä»¶è®¿é—®å±æ€§
	int mode = inode->i_mode;

	// ç‰¹æ®Šæƒ…å†µï¼šå³ä½¿æ˜¯è¶…çº§ç”¨æˆ·(root)ä¹Ÿä¸èƒ½è¯»/å†™ä¸€ä¸ªå·²è¢«åˆ é™¤çš„æ–‡ä»¶
	// å¦‚æœ i èŠ‚ç‚¹æœ‰å¯¹åº”çš„è®¾å¤‡ï¼Œä½†è¯¥ i èŠ‚ç‚¹çš„è¿æ¥æ•°ç­‰äº 0ï¼Œåˆ™è¿”å›
	if (inode->i_dev && !inode->i_nlinks)
		return 0;

	// å¦åˆ™ï¼Œå¦‚æœè¿›ç¨‹çš„æœ‰æ•ˆç”¨æˆ· id(euid) ä¸ i èŠ‚ç‚¹çš„ç”¨æˆ· id ç›¸åŒ
	// åˆ™å–æ–‡ä»¶å®¿ä¸»çš„ç”¨æˆ·è®¿é—®æƒé™
	else if (current->euid == inode->i_uid)
		mode >>= 6;

	// å¦åˆ™ï¼Œå¦‚æœè¿›ç¨‹çš„æœ‰æ•ˆç»„ id(egid) ä¸ i èŠ‚ç‚¹çš„ç»„ id ç›¸åŒï¼Œåˆ™å–ç»„ç”¨æˆ·çš„è®¿é—®æƒé™
	else if (current->egid == inode->i_gid)
		mode >>= 3;

	// å¦‚æœä¸Šé¢æ‰€å–çš„çš„è®¿é—®æƒé™ä¸å±è”½ç ç›¸åŒï¼Œæˆ–è€…æ˜¯è¶…çº§ç”¨æˆ·ï¼Œåˆ™è¿”å› 1ï¼Œå¦åˆ™è¿”å› 0
	if (((mode & mask & 0007) == mask) || suser())
		return 1;
	return 0;
}

// okï¼Œæˆ‘ä»¬ä¸èƒ½ä½¿ç”¨ strncmp å­—ç¬¦ä¸²æ¯”è¾ƒå‡½æ•°
// å› ä¸ºåç§°ä¸åœ¨æˆ‘ä»¬çš„æ•°æ®ç©ºé—´(ä¸åœ¨å†…æ ¸ç©ºé—´)ï¼Œå› è€Œæˆ‘ä»¬åªèƒ½ä½¿ç”¨ match()
// é—®é¢˜ä¸å¤§ï¼Œmatch() åŒæ ·ä¹Ÿå¤„ç†ä¸€äº›å®Œæ•´çš„æµ‹è¯•

// æ³¨æ„ï¼ä¸ strncmp ä¸åŒçš„æ˜¯ match() æˆåŠŸæ—¶è¿”å› 1ï¼Œå¤±è´¥æ—¶è¿”å› 0

// æŒ‡å®šé•¿åº¦å­—ç¬¦ä¸²æ¯”è¾ƒå‡½æ•°
// å‚æ•°ï¼š
// len - æ¯”è¾ƒçš„å­—ç¬¦ä¸²é•¿åº¦ï¼›
// name - æ–‡ä»¶åæŒ‡é’ˆï¼›
// de - ç›®å½•é¡¹ç»“æ„ï¼›
// è¿”å›ï¼šç›¸åŒè¿”å› 1ï¼Œä¸åŒè¿”å› 0
static int match(int len, const char *name, struct dir_entry *de)
{
	register int same;

	// å¦‚æœç›®å½•é¡¹æŒ‡é’ˆç©ºï¼Œæˆ–è€…ç›®å½•é¡¹ i èŠ‚ç‚¹ç­‰äº 0
	// æˆ–è€…è¦æ¯”è¾ƒçš„å­—ç¬¦ä¸²é•¿åº¦è¶…è¿‡æ–‡ä»¶åé•¿åº¦ï¼Œåˆ™è¿”å› 0
	if (!de || !de->inode || len > NAME_LEN)
		return 0;

	// å¦‚æœè¦æ¯”è¾ƒçš„é•¿åº¦ len å°äº NAME_LEN
	// ä½†æ˜¯ç›®å½•é¡¹ä¸­æ–‡ä»¶åé•¿åº¦è¶…è¿‡ lenï¼Œåˆ™è¿”å› 0
	if (len < NAME_LEN && de->name[len])
		return 0;

	// ä¸‹é¢å†…è”æ±‡ç¼–è¯­å¥ï¼Œåœ¨ç”¨æˆ·æ•°æ®ç©ºé—´(fs)æ‰§è¡Œå­—ç¬¦ä¸²çš„æ¯”è¾ƒæ“ä½œ
	// %0 - eax(æ¯”è¾ƒç»“æœsame)ï¼›
	// %1 - eax(eax åˆå€¼0)ï¼›
	// %2 - esi(åå­—æŒ‡é’ˆ)ï¼›
	// %3 - edi(ç›®å½•é¡¹åæŒ‡é’ˆ)ï¼›
	// %4 - ecx(æ¯”è¾ƒçš„å­—èŠ‚é•¿åº¦å€¼len)ï¼›
	__asm__("cld\n\t"
			"fs \n\t repe \n\t cmpsb\n\t"
			"setz %%al"
			: "=a"(same)
			: "0"(0), "S"((long)name), "D"((long)de->name), "c"(len));
	return same;
}

// find_entry()
// åœ¨æŒ‡å®šçš„ç›®å½•ä¸­å¯»æ‰¾ä¸€ä¸ªä¸åå­—åŒ¹é…çš„ç›®å½•é¡¹
// è¿”å›ä¸€ä¸ªå«æœ‰æ‰¾åˆ°ç›®å½•é¡¹çš„é«˜é€Ÿç¼“å†²åŒºä»¥åŠç›®å½•é¡¹æœ¬èº«(ä½œä¸ºä¸€ä¸ªå‚æ•° - res_dir)
// å¹¶ä¸è¯»ç›®å½•é¡¹çš„ i èŠ‚ç‚¹ - å¦‚æœéœ€è¦çš„è¯éœ€è‡ªå·±æ“ä½œ

// '..' ç›®å½•é¡¹ï¼Œæ“ä½œæœŸé—´ä¹Ÿä¼šå¯¹å‡ ç§ç‰¹æ®Šæƒ…å†µåˆ†åˆ«å¤„ç†
// æ¯”å¦‚æ¨ªè¶Šä¸€ä¸ªä¼ªæ ¹ç›®å½•ä»¥åŠå®‰è£…ç‚¹

// æŸ¥æ‰¾æŒ‡å®šç›®å½•å’Œæ–‡ä»¶åçš„ç›®å½•é¡¹
// å‚æ•°ï¼š
// dir - æŒ‡å®šç›®å½• i èŠ‚ç‚¹çš„æŒ‡é’ˆï¼›
// name - æ–‡ä»¶åï¼›
// namelen - æ–‡ä»¶åé•¿åº¦ï¼›
// è¿”å›ï¼šé«˜é€Ÿç¼“å†²åŒºæŒ‡é’ˆï¼›res_dir - è¿”å›çš„ç›®å½•é¡¹ç»“æ„æŒ‡é’ˆï¼›
static struct buffer_head *find_entry(
	struct m_inode **dir,
	const char *name,
	int namelen,
	struct dir_entry **res_dir)
{
	int entries;
	int block, i;
	struct buffer_head *bh;
	struct dir_entry *de;
	struct super_block *sb;

// å¦‚æœå®šä¹‰äº† NO_TRUNCATEï¼Œåˆ™è‹¥æ–‡ä»¶åé•¿åº¦è¶…è¿‡æœ€å¤§é•¿åº¦ NAME_LENï¼Œåˆ™è¿”å›
#ifdef NO_TRUNCATE
	if (namelen > NAME_LEN)
		return NULL;
// å¦‚æœæ²¡æœ‰å®šä¹‰ NO_TRUNCATEï¼Œåˆ™è‹¥æ–‡ä»¶åé•¿åº¦è¶…è¿‡æœ€å¤§é•¿åº¦ NAME_LENï¼Œåˆ™æˆªçŸ­ä¹‹
#else
	if (namelen > NAME_LEN)
		namelen = NAME_LEN;
#endif
	// è®¡ç®—æœ¬ç›®å½•ä¸­ç›®å½•é¡¹é¡¹æ•° entriesï¼Œç½®ç©ºè¿”å›ç›®å½•é¡¹ç»“æ„æŒ‡é’ˆ
	entries = (*dir)->i_size / (sizeof(struct dir_entry));
	*res_dir = NULL;

	// å¦‚æœæ–‡ä»¶åé•¿åº¦ç­‰äº 0ï¼Œåˆ™è¿”å› NULLï¼Œé€€å‡º
	if (!namelen)
		return NULL;

	// æ£€æŸ¥ç›®å½•é¡¹'..'ï¼Œå› ä¸ºå¯èƒ½éœ€è¦å¯¹å…¶ç‰¹åˆ«å¤„ç†
	if (namelen == 2 && get_fs_byte(name) == '.' && get_fs_byte(name + 1) == '.')
	{
		// ä¼ªæ ¹ä¸­çš„ '..' å¦‚åŒä¸€ä¸ªå‡ '.' (åªéœ€æ”¹å˜åå­—é•¿åº¦)
		// å¦‚æœå½“å‰è¿›ç¨‹çš„æ ¹èŠ‚ç‚¹æŒ‡é’ˆå³æ˜¯æŒ‡å®šçš„ç›®å½•ï¼Œåˆ™å°†æ–‡ä»¶åä¿®æ”¹ä¸º '.'
		if ((*dir) == current->root)
			namelen = 1;

		// å¦åˆ™å¦‚æœè¯¥ç›®å½•çš„ i èŠ‚ç‚¹å·ç­‰äº ROOT_INO(1) çš„è¯
		// è¯´æ˜æ˜¯æ–‡ä»¶ç³»ç»Ÿæ ¹èŠ‚ç‚¹ï¼Œåˆ™å–æ–‡ä»¶ç³»ç»Ÿçš„è¶…çº§å—
		else if ((*dir)->i_num == ROOT_INO)
		{
			// åœ¨ä¸€ä¸ªå®‰è£…ç‚¹ä¸Šçš„ '..' å°†å¯¼è‡´ç›®å½•äº¤æ¢åˆ°å®‰è£…åˆ°æ–‡ä»¶ç³»ç»Ÿçš„ç›®å½• i èŠ‚ç‚¹
			// æ³¨æ„ï¼ç”±äºè®¾ç½®äº† mounted æ ‡å¿—ï¼Œå› è€Œæˆ‘ä»¬èƒ½å¤Ÿå–å‡ºè¯¥æ–°ç›®å½•
			sb = get_super((*dir)->i_dev);

			// å¦‚æœè¢«å®‰è£…åˆ°çš„ i èŠ‚ç‚¹å­˜åœ¨ï¼Œåˆ™å…ˆé‡Šæ”¾åŸ i èŠ‚ç‚¹ï¼Œç„¶åå¯¹è¢«å®‰è£…åˆ°çš„ i èŠ‚ç‚¹è¿›è¡Œå¤„ç†
			// è®© *dir æŒ‡å‘è¯¥è¢«å®‰è£…åˆ°çš„ i èŠ‚ç‚¹ï¼›è¯¥ i èŠ‚ç‚¹çš„å¼•ç”¨æ•°åŠ  1
			if (sb->s_imount)
			{
				iput(*dir);
				(*dir) = sb->s_imount;
				(*dir)->i_count++;
			}
		}
	}

	// å¦‚æœè¯¥ i èŠ‚ç‚¹æ‰€æŒ‡å‘çš„ç¬¬ä¸€ä¸ªç›´æ¥ç£ç›˜å—å·ä¸º 0ï¼Œåˆ™è¿”å› NULLï¼Œé€€å‡º
	if (!(block = (*dir)->i_zone[0]))
		return NULL;

	// ä»èŠ‚ç‚¹æ‰€åœ¨è®¾å¤‡è¯»å–æŒ‡å®šçš„ç›®å½•é¡¹æ•°æ®å—ï¼Œå¦‚æœä¸æˆåŠŸï¼Œåˆ™è¿”å› NULLï¼Œé€€å‡º
	if (!(bh = bread((*dir)->i_dev, block)))
		return NULL;

	// åœ¨ç›®å½•é¡¹æ•°æ®å—ä¸­æœç´¢åŒ¹é…æŒ‡å®šæ–‡ä»¶åçš„ç›®å½•é¡¹ï¼Œ
	// é¦–å…ˆè®© de æŒ‡å‘æ•°æ®å—å¹¶åœ¨ä¸è¶…è¿‡ç›®å½•ä¸­ç›®å½•é¡¹æ•°çš„æ¡ä»¶ä¸‹ï¼Œå¾ªç¯æ‰§è¡Œæœç´¢
	i = 0;
	de = (struct dir_entry *)bh->b_data;
	while (i < entries)
	{
		// å¦‚æœå½“å‰ç›®å½•é¡¹æ•°æ®å—å·²ç»æœç´¢å®Œï¼Œè¿˜æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç›®å½•é¡¹ï¼Œåˆ™é‡Šæ”¾å½“å‰ç›®å½•é¡¹æ•°æ®å—
		if ((char *)de >= BLOCK_SIZE + bh->b_data)
		{
			brelse(bh);
			bh = NULL;

			// åœ¨è¯»å…¥ä¸‹ä¸€ç›®å½•é¡¹æ•°æ®å—
			// è‹¥è¿™å—ä¸ºç©ºï¼Œåˆ™åªè¦è¿˜æ²¡æœ‰æœç´¢å®Œç›®å½•ä¸­çš„æ‰€æœ‰ç›®å½•é¡¹
			// å°±è·³è¿‡è¯¥å—ï¼Œç»§ç»­è¯»ä¸‹ä¸€ç›®å½•é¡¹æ•°æ®å—
			// è‹¥è¯¥å—ä¸ç©ºï¼Œå°±è®© de æŒ‡å‘è¯¥ç›®å½•é¡¹æ•°æ®å—ï¼Œç»§ç»­æœç´¢
			if (!(block = bmap(*dir, i / DIR_ENTRIES_PER_BLOCK)) ||
				!(bh = bread((*dir)->i_dev, block)))
			{
				i += DIR_ENTRIES_PER_BLOCK;
				continue;
			}
			de = (struct dir_entry *)bh->b_data;
		}

		// å¦‚æœæ‰¾åˆ°åŒ¹é…çš„ç›®å½•é¡¹çš„è¯ï¼Œåˆ™è¿”å› è¯¥ç›®å½•é¡¹ç»“æ„æŒ‡é’ˆ å’Œ è¯¥ç›®å½•é¡¹æ•°æ®å—æŒ‡é’ˆï¼Œé€€å‡º
		if (match(namelen, name, de))
		{
			*res_dir = de;
			return bh;
		}
		// å¦åˆ™ç»§ç»­åœ¨ç›®å½•é¡¹æ•°æ®å—ä¸­æ¯”è¾ƒä¸‹ä¸€ä¸ªç›®å½•é¡¹
		de++;
		i++;
	}

	// è‹¥æŒ‡å®šç›®å½•ä¸­çš„æ‰€æœ‰ç›®å½•é¡¹éƒ½æœç´¢å®Œï¼Œè¿˜æ²¡æœ‰æ‰¾åˆ°ç›¸åº”çš„ç›®å½•é¡¹
	// åˆ™é‡Šæ”¾ç›®å½•é¡¹æ•°æ®å—ï¼Œè¿”å› NULL
	brelse(bh);
	return NULL;
}

// add_entry()
// ä½¿ç”¨ä¸ find_entry()åŒæ ·çš„æ–¹æ³•ï¼Œå¾€æŒ‡å®šç›®å½•ä¸­æ·»åŠ ä¸€æ–‡ä»¶ç›®å½•é¡¹ï¼Œå¦‚æœå¤±è´¥åˆ™è¿”å› NULL

// æ³¨æ„ï¼ï¼'de'(æŒ‡å®šç›®å½•é¡¹ç»“æ„æŒ‡é’ˆ) çš„ i èŠ‚ç‚¹éƒ¨åˆ†è¢«è®¾ç½®ä¸º 0
// è¿™è¡¨ç¤ºåœ¨è°ƒç”¨è¯¥å‡½æ•°å’Œå¾€ç›®å½•é¡¹ä¸­æ·»åŠ ä¿¡æ¯ä¹‹é—´ä¸èƒ½ç¡çœ 
// å› ä¸ºè‹¥ç¡çœ é‚£ä¹ˆå…¶å®ƒäºº(è¿›ç¨‹)å¯èƒ½ä¼šå·²ç»ä½¿ç”¨äº†è¯¥ç›®å½•é¡¹

// æ ¹æ®æŒ‡å®šçš„ç›®å½•å’Œæ–‡ä»¶åæ·»åŠ ç›®å½•é¡¹
// å‚æ•°ï¼š
// dir - æŒ‡å®šç›®å½•çš„ i èŠ‚ç‚¹ï¼›
// name - æ–‡ä»¶åï¼›
// namelen - æ–‡ä»¶åé•¿åº¦ï¼›
// è¿”å›ï¼šé«˜é€Ÿç¼“å†²åŒºæŒ‡é’ˆï¼›res_dir - è¿”å›çš„ç›®å½•é¡¹ç»“æ„æŒ‡é’ˆï¼›
static struct buffer_head *add_entry(
	struct m_inode *dir,
	const char *name,
	int namelen,
	struct dir_entry **res_dir)
{
	int block, i;
	struct buffer_head *bh;
	struct dir_entry *de;

	*res_dir = NULL;

// å¦‚æœå®šä¹‰äº† NO_TRUNCATEï¼Œåˆ™è‹¥æ–‡ä»¶åé•¿åº¦è¶…è¿‡æœ€å¤§é•¿åº¦ NAME_LENï¼Œåˆ™è¿”å›
#ifdef NO_TRUNCATE
	if (namelen > NAME_LEN)
		return NULL;

//å¦‚æœæ²¡æœ‰å®šä¹‰ NO_TRUNCATEï¼Œåˆ™è‹¥æ–‡ä»¶åé•¿åº¦è¶…è¿‡æœ€å¤§é•¿åº¦ NAME_LENï¼Œåˆ™æˆªçŸ­ä¹‹
#else
	if (namelen > NAME_LEN)
		namelen = NAME_LEN;
#endif

	// å¦‚æœæ–‡ä»¶åé•¿åº¦ç­‰äº 0ï¼Œåˆ™è¿”å› NULLï¼Œé€€å‡º
	if (!namelen)
		return NULL;

	// å¦‚æœè¯¥ç›®å½• i èŠ‚ç‚¹æ‰€æŒ‡å‘çš„ç¬¬ä¸€ä¸ªç›´æ¥ç£ç›˜å—å·ä¸º 0ï¼Œåˆ™è¿”å› NULL é€€å‡º
	if (!(block = dir->i_zone[0]))
		return NULL;

	// å¦‚æœè¯»å–è¯¥ç£ç›˜å—å¤±è´¥ï¼Œåˆ™è¿”å› NULL å¹¶é€€å‡º
	if (!(bh = bread(dir->i_dev, block)))
		return NULL;

	// åœ¨ç›®å½•é¡¹æ•°æ®å—ä¸­å¾ªç¯æŸ¥æ‰¾æœ€åæœªä½¿ç”¨çš„ç›®å½•é¡¹
	// é¦–å…ˆè®©ç›®å½•é¡¹ç»“æ„æŒ‡é’ˆ de æŒ‡å‘é«˜é€Ÿç¼“å†²çš„æ•°æ®å—å¼€å§‹å¤„ï¼Œä¹Ÿå³ç¬¬ä¸€ä¸ªç›®å½•é¡¹
	i = 0;
	de = (struct dir_entry *)bh->b_data;
	while (1)
	{
		// å¦‚æœå½“å‰åˆ¤åˆ«çš„ç›®å½•é¡¹å·²ç»è¶…å‡ºå½“å‰æ•°æ®å—
		// åˆ™é‡Šæ”¾è¯¥æ•°æ®å—ï¼Œé‡æ–°ç”³è¯·ä¸€å—ç£ç›˜å— block
		// å¦‚æœç”³è¯·å¤±è´¥ï¼Œåˆ™è¿”å› NULLï¼Œé€€å‡º
		if ((char *)de >= BLOCK_SIZE + bh->b_data)
		{
			brelse(bh);
			bh = NULL;
			block = create_block(dir, i / DIR_ENTRIES_PER_BLOCK);
			if (!block)
				return NULL;

			// å¦‚æœè¯»å–ç£ç›˜å—è¿”å›çš„æŒ‡é’ˆä¸ºç©ºï¼Œåˆ™è·³è¿‡è¯¥å—ç»§ç»­
			if (!(bh = bread(dir->i_dev, block)))
			{
				i += DIR_ENTRIES_PER_BLOCK;
				continue;
			}

			// å¦åˆ™ï¼Œè®©ç›®å½•é¡¹ç»“æ„æŒ‡é’ˆ de æŒ‡å‘è¯¥å—çš„é«˜é€Ÿç¼“å†²æ•°æ®å—å¼€å§‹å¤„
			de = (struct dir_entry *)bh->b_data;
		}

		// å¦‚æœå½“å‰æ‰€æ“ä½œçš„ç›®å½•é¡¹åºå· i*ç›®å½•ç»“æ„å¤§å° å·²ç»è¶…è¿‡äº†è¯¥ç›®å½•æ‰€æŒ‡å‡ºçš„å¤§å° i_size
		// åˆ™è¯´æ˜è¯¥ç¬¬ i ä¸ªç›®å½•é¡¹è¿˜æœªä½¿ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒ
		// äºæ˜¯å¯¹è¯¥ç›®å½•é¡¹è¿›è¡Œè®¾ç½®(ç½®è¯¥ç›®å½•é¡¹çš„ i èŠ‚ç‚¹æŒ‡é’ˆä¸ºç©º)ï¼Œå¹¶æ›´æ–°è¯¥ç›®å½•çš„é•¿åº¦å€¼
		// (åŠ ä¸Šä¸€ä¸ªç›®å½•é¡¹çš„é•¿åº¦ï¼Œè®¾ç½®ç›®å½•çš„i èŠ‚ç‚¹å·²ä¿®æ”¹æ ‡å¿—ï¼Œå†æ›´æ–°è¯¥ç›®å½•çš„æ”¹å˜æ—¶é—´ä¸ºå½“å‰æ—¶é—´ï¼‰
		if (i * sizeof(struct dir_entry) >= dir->i_size)
		{
			de->inode = 0;
			dir->i_size = (i + 1) * sizeof(struct dir_entry);
			dir->i_dirt = 1;
			dir->i_ctime = CURRENT_TIME;
		}

		// è‹¥è¯¥ç›®å½•é¡¹çš„ i èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºæ‰¾åˆ°ä¸€ä¸ªè¿˜æœªä½¿ç”¨çš„ç›®å½•é¡¹
		// äºæ˜¯æ›´æ–°ç›®å½•çš„ä¿®æ”¹æ—¶é—´ä¸ºå½“å‰æ—¶é—´
		// å¹¶ä»ç”¨æˆ·æ•°æ®åŒºå¤åˆ¶æ–‡ä»¶ååˆ°è¯¥ç›®å½•é¡¹çš„æ–‡ä»¶åå­—æ®µï¼Œç½®ç›¸åº”çš„é«˜é€Ÿç¼“å†²å—å·²ä¿®æ”¹æ ‡å¿—
		// è¿”å›è¯¥ç›®å½•é¡¹çš„æŒ‡é’ˆä»¥åŠè¯¥é«˜é€Ÿç¼“å†²åŒºçš„æŒ‡é’ˆï¼Œé€€å‡º
		if (!de->inode)
		{
			dir->i_mtime = CURRENT_TIME;
			for (i = 0; i < NAME_LEN; i++)
				de->name[i] = (i < namelen) ? get_fs_byte(name + i) : 0;
			bh->b_dirt = 1;
			*res_dir = de;
			return bh;
		}

		// å¦‚æœè¯¥ç›®å½•é¡¹å·²ç»è¢«ä½¿ç”¨ï¼Œåˆ™ç»§ç»­æ£€æµ‹ä¸‹ä¸€ä¸ªç›®å½•é¡¹
		de++;
		i++;
	}
	// æ‰§è¡Œä¸åˆ°è¿™é‡Œ
	// ä¹Ÿè®¸ Linus åœ¨å†™è¿™æ®µä»£ç æ—¶ï¼Œå…ˆå¤åˆ¶äº†ä¸Šé¢ find_entry() çš„ä»£ç ï¼Œè€Œåä¿®æ”¹çš„ ğŸ˜œ
	// [æ²¡é”™ï¼Œæˆ‘ä¹Ÿç»å¸¸è¿™æ ·å¹²ï¼Œè¯´æ˜ä»£ç è¿˜æœ‰ä¼˜åŒ–çš„åœ°æ–¹]
	brelse(bh);
	return NULL;
}

// get_dir()
// è¯¥å‡½æ•°æ ¹æ®ç»™å‡ºçš„è·¯å¾„åè¿›è¡Œæœç´¢ï¼Œç›´åˆ°è¾¾åˆ°æœ€é¡¶ç«¯çš„ç›®å½•
// å¦‚æœå¤±è´¥åˆ™è¿”å› NULL

// æœå¯»æŒ‡å®šè·¯å¾„åçš„ç›®å½•
// å‚æ•°ï¼špathname - è·¯å¾„å
// è¿”å›ï¼šç›®å½•çš„ i èŠ‚ç‚¹æŒ‡é’ˆï¼Œå¤±è´¥æ—¶è¿”å› NULL
static struct m_inode *get_dir(const char *pathname)
{
	char c;
	const char *thisname;
	struct m_inode *inode;
	struct buffer_head *bh;
	int namelen, inr, idev;
	struct dir_entry *de;

	// å¦‚æœè¿›ç¨‹æ²¡æœ‰è®¾å®šæ ¹ i èŠ‚ç‚¹ï¼Œæˆ–è€…è¯¥è¿›ç¨‹æ ¹ i èŠ‚ç‚¹çš„å¼•ç”¨ä¸º 0ï¼Œåˆ™ç³»ç»Ÿå‡ºé”™ï¼Œæ­»æœº
	if (!current->root || !current->root->i_count)
		panic("No root inode");

	// å¦‚æœè¿›ç¨‹çš„å½“å‰å·¥ä½œç›®å½•æŒ‡é’ˆä¸ºç©º
	// æˆ–è€…è¯¥å½“å‰ç›®å½• i èŠ‚ç‚¹çš„å¼•ç”¨è®¡æ•°ä¸º 0ï¼Œä¹Ÿæ˜¯ç³»ç»Ÿæœ‰é—®é¢˜ï¼Œæ­»æœº
	if (!current->pwd || !current->pwd->i_count)
		panic("No cwd inode");

	// å¦‚æœç”¨æˆ·æŒ‡å®šçš„è·¯å¾„åçš„ç¬¬ 1 ä¸ªå­—ç¬¦æ˜¯ '/'
	// åˆ™è¯´æ˜è·¯å¾„åæ˜¯ç»å¯¹è·¯å¾„åï¼Œä»æ ¹ i èŠ‚ç‚¹å¼€å§‹æ“ä½œ
	if ((c = get_fs_byte(pathname)) == '/')
	{
		inode = current->root;
		pathname++;
	}
	// å¦åˆ™è‹¥ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯å…¶å®ƒå­—ç¬¦ï¼Œåˆ™è¡¨ç¤ºç»™å®šçš„æ˜¯ç›¸å¯¹è·¯å¾„å
	// åº”ä»è¿›ç¨‹çš„å½“å‰å·¥ä½œç›®å½•å¼€å§‹æ“ä½œï¼Œåˆ™å–è¿›ç¨‹å½“å‰å·¥ä½œç›®å½•çš„ i èŠ‚ç‚¹
	else if (c)
		inode = current->pwd;
	// å¦åˆ™è¡¨ç¤ºè·¯å¾„åä¸ºç©ºï¼Œå‡ºé”™ï¼Œè¿”å› NULLï¼Œé€€å‡º
	else
		// ç©ºçš„è·¯å¾„åæ˜¯é”™è¯¯çš„
		return NULL; /* empty name is bad */

	// å°†å–å¾—çš„ i èŠ‚ç‚¹å¼•ç”¨è®¡æ•°å¢ 1
	inode->i_count++;
	while (1)
	{
		// è‹¥è¯¥ i èŠ‚ç‚¹ä¸æ˜¯ç›®å½•èŠ‚ç‚¹ï¼Œæˆ–è€…æ²¡æœ‰å¯è¿›å…¥çš„è®¿é—®è®¸å¯ï¼Œåˆ™é‡Šæ”¾è¯¥ i èŠ‚ç‚¹ï¼Œè¿”å› NULLï¼Œé€€å‡º
		thisname = pathname;
		if (!S_ISDIR(inode->i_mode) || !permission(inode, MAY_EXEC))
		{
			iput(inode);
			return NULL;
		}

		// ä»è·¯å¾„åå¼€å§‹èµ·æœç´¢æ£€æµ‹å­—ç¬¦ï¼Œç›´åˆ°å­—ç¬¦å·²æ˜¯ç»“å°¾ç¬¦ (NULL) æˆ–è€…æ˜¯'/'
		// æ­¤æ—¶ namelen æ­£å¥½æ˜¯å½“å‰å¤„ç†ç›®å½•åçš„é•¿åº¦
		// å¦‚æœæœ€åä¹Ÿæ˜¯ä¸€ä¸ªç›®å½•åï¼Œä½†å…¶åæ²¡æœ‰åŠ '/'ï¼Œåˆ™ä¸ä¼šè¿”å›è¯¥æœ€åç›®å½•çš„ i èŠ‚ç‚¹ ï¼
		// æ¯”å¦‚ï¼š/var/log/httpdï¼Œå°†åªè¿”å› log/ ç›®å½•çš„ i èŠ‚ç‚¹
		for (namelen = 0; (c = get_fs_byte(pathname++)) && (c != '/'); namelen++)
			/* nothing */;

		// è‹¥å­—ç¬¦æ˜¯ç»“å°¾ç¬¦ NULLï¼Œåˆ™è¡¨æ˜å·²ç»åˆ°è¾¾æŒ‡å®šç›®å½•ï¼Œåˆ™è¿”å›è¯¥ i èŠ‚ç‚¹æŒ‡é’ˆï¼Œé€€å‡º
		if (!c)
			return inode;

		// è°ƒç”¨æŸ¥æ‰¾æŒ‡å®šç›®å½•å’Œæ–‡ä»¶åçš„ç›®å½•é¡¹å‡½æ•°ï¼Œåœ¨å½“å‰å¤„ç†ç›®å½•ä¸­å¯»æ‰¾å­ç›®å½•é¡¹
		// å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™é‡Šæ”¾è¯¥ i èŠ‚ç‚¹ï¼Œå¹¶è¿”å› NULLï¼Œé€€å‡º
		if (!(bh = find_entry(&inode, thisname, namelen, &de)))
		{
			iput(inode);
			return NULL;
		}

		// å–è¯¥å­ç›®å½•é¡¹çš„ i èŠ‚ç‚¹å· inr å’Œè®¾å¤‡å· idev
		// é‡Šæ”¾åŒ…å«è¯¥ç›®å½•é¡¹çš„é«˜é€Ÿç¼“å†²å—å’Œè¯¥ i èŠ‚ç‚¹
		inr = de->inode;
		idev = inode->i_dev;
		brelse(bh);
		iput(inode);

		// å–èŠ‚ç‚¹å· inr çš„ i èŠ‚ç‚¹ä¿¡æ¯ï¼Œè‹¥å¤±è´¥ï¼Œåˆ™è¿”å› NULLï¼Œé€€å‡º
		// å¦åˆ™ç»§ç»­ä»¥è¯¥å­ç›®å½•çš„ i èŠ‚ç‚¹è¿›è¡Œæ“ä½œ
		if (!(inode = iget(idev, inr)))
			return NULL;
	}
}

// dir_namei() å‡½æ•°è¿”å›æŒ‡å®šç›®å½•åçš„ i èŠ‚ç‚¹æŒ‡é’ˆï¼Œä»¥åŠåœ¨æœ€é¡¶å±‚ç›®å½•çš„åç§°

// å‚æ•°ï¼špathname - ç›®å½•è·¯å¾„åï¼›namelen - è·¯å¾„åé•¿åº¦ã€‚
// è¿”å›ï¼šæŒ‡å®šç›®å½•åæœ€é¡¶å±‚ç›®å½•çš„ i èŠ‚ç‚¹æŒ‡é’ˆå’Œæœ€é¡¶å±‚ç›®å½•ååŠå…¶é•¿åº¦
static struct m_inode *dir_namei(const char *pathname,
								 int *namelen, const char **name)
{
	char c;
	const char *basename;
	struct m_inode *dir;

	// å–æŒ‡å®šè·¯å¾„åæœ€é¡¶å±‚ç›®å½•çš„ i èŠ‚ç‚¹ï¼Œè‹¥å‡ºé”™åˆ™è¿”å› NULLï¼Œé€€å‡º
	if (!(dir = get_dir(pathname)))
		return NULL;

	// å¯¹è·¯å¾„å pathname è¿›è¡Œæœç´¢æ£€æµ‹ï¼ŒæŸ¥å¤„æœ€åä¸€ä¸ª '/' åé¢çš„åå­—å­—ç¬¦ä¸²
	// è®¡ç®—å…¶é•¿åº¦ï¼Œå¹¶è¿”å›æœ€é¡¶å±‚ç›®å½•çš„ i èŠ‚ç‚¹æŒ‡é’ˆ
	basename = pathname;
	while ((c = get_fs_byte(pathname++)))
		if (c == '/')
			basename = pathname;
	*namelen = pathname - basename - 1;
	*name = basename;
	return dir;
}

// namei()
// è¯¥å‡½æ•°è¢«è®¸å¤šç®€å•çš„å‘½ä»¤ç”¨äºå–å¾—æŒ‡å®šè·¯å¾„åç§°çš„ i èŠ‚ç‚¹
// openã€link ç­‰åˆ™ä½¿ç”¨å®ƒä»¬è‡ªå·±çš„ç›¸åº”å‡½æ•°
// ä½†å¯¹äºåƒä¿®æ”¹æ¨¡å¼ 'chmod' ç­‰è¿™æ ·çš„å‘½ä»¤ï¼Œè¯¥å‡½æ•°å·²è¶³å¤Ÿç”¨äº†

// å–æŒ‡å®šè·¯å¾„åçš„ i èŠ‚ç‚¹
// å‚æ•°ï¼špathname - è·¯å¾„å
// è¿”å›ï¼šå¯¹åº”çš„ i èŠ‚ç‚¹
struct m_inode *namei(const char *pathname)
{
	const char *basename;
	int inr, dev, namelen;
	struct m_inode *dir;
	struct buffer_head *bh;
	struct dir_entry *de;

	// é¦–å…ˆæŸ¥æ‰¾æŒ‡å®šè·¯å¾„çš„æœ€é¡¶å±‚ç›®å½•çš„ç›®å½•ååŠå…¶ i èŠ‚ç‚¹ï¼Œè‹¥ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› NULLï¼Œé€€å‡º
	if (!(dir = dir_namei(pathname, &namelen, &basename)))
		return NULL;

	// å¦‚æœè¿”å›çš„æœ€é¡¶å±‚åå­—çš„é•¿åº¦æ˜¯ 0ï¼Œåˆ™è¡¨ç¤ºè¯¥è·¯å¾„åä»¥ä¸€ä¸ªç›®å½•åä¸ºæœ€åä¸€é¡¹
	if (!namelen) /* special case: '/usr/' etc */
		// å¯¹åº”äº'/usr/'ç­‰æƒ…å†µ
		return dir;

	// åœ¨è¿”å›çš„é¡¶å±‚ç›®å½•ä¸­å¯»æ‰¾æŒ‡å®šæ–‡ä»¶åçš„ç›®å½•é¡¹çš„ i èŠ‚ç‚¹
	// å› ä¸ºå¦‚æœæœ€åä¹Ÿæ˜¯ä¸€ä¸ªç›®å½•åï¼Œä½†å…¶åæ²¡æœ‰åŠ '/'
	// åˆ™ä¸ä¼šè¿”å›è¯¥æœ€åç›®å½•çš„ i èŠ‚ç‚¹ï¼
	// æ¯”å¦‚ï¼š/var/log/httpdï¼Œå°†åªè¿”å› log/ ç›®å½•çš„ i èŠ‚ç‚¹
	// å› æ­¤ dir_namei() å°†ä¸ä»¥ '/' ç»“æŸçš„æœ€åä¸€ä¸ªåå­—å½“ä½œä¸€ä¸ªæ–‡ä»¶åæ¥çœ‹å¾…
	// å› æ­¤è¿™é‡Œéœ€è¦å•ç‹¬å¯¹è¿™ç§æƒ…å†µä½¿ç”¨å¯»æ‰¾ç›®å½•é¡¹ i èŠ‚ç‚¹å‡½æ•° find_entry() è¿›è¡Œå¤„ç†
	bh = find_entry(&dir, basename, namelen, &de);
	if (!bh)
	{
		iput(dir);
		return NULL;
	}

	// å–è¯¥ç›®å½•é¡¹çš„ i èŠ‚ç‚¹å·å’Œç›®å½•çš„è®¾å¤‡å·
	// å¹¶é‡Šæ”¾åŒ…å«è¯¥ç›®å½•é¡¹çš„é«˜é€Ÿç¼“å†²åŒºä»¥åŠç›®å½• i èŠ‚ç‚¹
	inr = de->inode;
	dev = dir->i_dev;
	brelse(bh);
	iput(dir);

	// å–å¯¹åº”èŠ‚å·çš„ i èŠ‚ç‚¹ï¼Œä¿®æ”¹å…¶è¢«è®¿é—®æ—¶é—´ä¸ºå½“å‰æ—¶é—´ï¼Œå¹¶ç½®å·²ä¿®æ”¹æ ‡å¿—
	// æœ€åè¿”å›è¯¥ i èŠ‚ç‚¹æŒ‡é’ˆ
	dir = iget(dev, inr);
	if (dir)
	{
		dir->i_atime = CURRENT_TIME;
		dir->i_dirt = 1;
	}
	return dir;
}

// open_namei()
// open() æ‰€ä½¿ç”¨çš„ namei å‡½æ•° - è¿™å…¶å®å‡ ä¹æ˜¯å®Œæ•´çš„æ‰“å¼€æ–‡ä»¶ç¨‹åº

// æ–‡ä»¶æ‰“å¼€ namei å‡½æ•°
// å‚æ•°ï¼š
// pathname - æ–‡ä»¶è·¯å¾„åï¼›
// flag - æ–‡ä»¶æ‰“å¼€æ ‡å¿—ï¼›
// mode - æ–‡ä»¶è®¿é—®è®¸å¯å±æ€§ï¼›
// è¿”å›ï¼šæˆåŠŸè¿”å› 0ï¼Œå¦åˆ™è¿”å›å‡ºé”™ç ï¼›res_inode - è¿”å›çš„å¯¹åº”æ–‡ä»¶è·¯å¾„åçš„çš„ i èŠ‚ç‚¹æŒ‡é’ˆ
int open_namei(const char *pathname, int flag, int mode,
			   struct m_inode **res_inode)
{
	const char *basename;
	int inr, dev, namelen;
	struct m_inode *dir, *inode;
	struct buffer_head *bh;
	struct dir_entry *de;

	// å¦‚æœæ–‡ä»¶è®¿é—®è®¸å¯æ¨¡å¼æ ‡å¿—æ˜¯åªè¯»(0)
	// ä½†æ–‡ä»¶æˆª 0 æ ‡å¿— O_TRUNC å´ç½®ä½äº†ï¼Œåˆ™æ”¹ä¸ºåªå†™æ ‡å¿—
	if ((flag & O_TRUNC) && !(flag & O_ACCMODE))
		flag |= O_WRONLY;

	// ä½¿ç”¨è¿›ç¨‹çš„æ–‡ä»¶è®¿é—®è®¸å¯å±è”½ç ï¼Œå±è”½æ‰ç»™å®šæ¨¡å¼ä¸­çš„ç›¸åº”ä½ï¼Œå¹¶æ·»ä¸Šæ™®é€šæ–‡ä»¶æ ‡å¿—
	mode &= 0777 & ~current->umask;
	mode |= I_REGULAR;

	// æ ¹æ®è·¯å¾„åå¯»æ‰¾åˆ°å¯¹åº”çš„ i èŠ‚ç‚¹ï¼Œä»¥åŠæœ€é¡¶ç«¯æ–‡ä»¶ååŠå…¶é•¿åº¦
	if (!(dir = dir_namei(pathname, &namelen, &basename)))
		return -ENOENT;

	// å¦‚æœæœ€é¡¶ç«¯æ–‡ä»¶åé•¿åº¦ä¸º 0(ä¾‹å¦‚'/usr/'è¿™ç§è·¯å¾„åçš„æƒ…å†µ)
	// é‚£ä¹ˆè‹¥æ‰“å¼€æ“ä½œä¸æ˜¯åˆ›å»ºã€æˆª0ï¼Œ
	// åˆ™è¡¨ç¤ºæ‰“å¼€ä¸€ä¸ªç›®å½•åï¼Œç›´æ¥è¿”å›è¯¥ç›®å½•çš„ i èŠ‚ç‚¹ï¼Œå¹¶é€€å‡º
	if (!namelen)
	{ /* special case: '/usr/' etc */
		if (!(flag & (O_ACCMODE | O_CREAT | O_TRUNC)))
		{
			*res_inode = dir;
			return 0;
		}
		// å¦åˆ™é‡Šæ”¾è¯¥ i èŠ‚ç‚¹ï¼Œè¿”å›å‡ºé”™ç 
		iput(dir);
		return -EISDIR;
	}

	// åœ¨ dir èŠ‚ç‚¹å¯¹åº”çš„ç›®å½•ä¸­å–æ–‡ä»¶åå¯¹åº”çš„ç›®å½•é¡¹ç»“æ„ de å’Œ è¯¥ç›®å½•é¡¹æ‰€åœ¨çš„é«˜é€Ÿç¼“å†²åŒº
	bh = find_entry(&dir, basename, namelen, &de);

	// å¦‚æœè¯¥é«˜é€Ÿç¼“å†²æŒ‡é’ˆä¸º NULLï¼Œåˆ™è¡¨ç¤ºæ²¡æœ‰æ‰¾åˆ°å¯¹åº”æ–‡ä»¶åçš„ç›®å½•é¡¹ï¼Œå› æ­¤åªå¯èƒ½æ˜¯åˆ›å»ºæ–‡ä»¶æ“ä½œ
	if (!bh)
	{
		// å¦‚æœä¸æ˜¯åˆ›å»ºæ–‡ä»¶ï¼Œåˆ™é‡Šæ”¾è¯¥ç›®å½•çš„ i èŠ‚ç‚¹ï¼Œè¿”å›å‡ºé”™å·é€€å‡º
		if (!(flag & O_CREAT))
		{
			iput(dir);
			return -ENOENT;
		}

		// å¦‚æœç”¨æˆ·åœ¨è¯¥ç›®å½•æ²¡æœ‰å†™çš„æƒåŠ›ï¼Œåˆ™é‡Šæ”¾è¯¥ç›®å½•çš„ i èŠ‚ç‚¹ï¼Œè¿”å›å‡ºé”™å·é€€å‡º
		if (!permission(dir, MAY_WRITE))
		{
			iput(dir);
			return -EACCES;
		}

		// åœ¨ç›®å½•èŠ‚ç‚¹å¯¹åº”çš„è®¾å¤‡ä¸Šç”³è¯·ä¸€ä¸ªæ–° i èŠ‚ç‚¹ï¼Œè‹¥å¤±è´¥
		// åˆ™é‡Šæ”¾ç›®å½•çš„ i èŠ‚ç‚¹ï¼Œå¹¶è¿”å›æ²¡æœ‰ç©ºé—´å‡ºé”™ç 
		inode = new_inode(dir->i_dev);
		if (!inode)
		{
			iput(dir);
			return -ENOSPC;
		}

		// å¦åˆ™ä½¿ç”¨è¯¥æ–° i èŠ‚ç‚¹ï¼Œå¯¹å…¶è¿›è¡Œåˆå§‹è®¾ç½®ï¼šç½®èŠ‚ç‚¹çš„ç”¨æˆ· idï¼›
		// å¯¹åº”èŠ‚ç‚¹è®¿é—®æ¨¡å¼ï¼›ç½®å·²ä¿®æ”¹æ ‡å¿—
		inode->i_uid = current->euid;
		inode->i_mode = mode;
		inode->i_dirt = 1;

		// ç„¶ååœ¨æŒ‡å®šç›®å½• dir ä¸­æ·»åŠ ä¸€æ–°ç›®å½•é¡¹
		bh = add_entry(dir, basename, namelen, &de);

		// å¦‚æœè¿”å›çš„åº”è¯¥å«æœ‰æ–°ç›®å½•é¡¹çš„é«˜é€Ÿç¼“å†²åŒºæŒ‡é’ˆä¸º NULLï¼Œåˆ™è¡¨ç¤ºæ·»åŠ ç›®å½•é¡¹æ“ä½œå¤±è´¥
		// äºæ˜¯å°†è¯¥æ–° i èŠ‚ç‚¹çš„å¼•ç”¨è¿æ¥è®¡æ•°å‡ 1ï¼›
		// å¹¶é‡Šæ”¾è¯¥ i èŠ‚ç‚¹ä¸ç›®å½•çš„ i èŠ‚ç‚¹ï¼Œè¿”å›å‡ºé”™ç ï¼Œé€€å‡º
		if (!bh)
		{
			inode->i_nlinks--;
			iput(inode);
			iput(dir);
			return -ENOSPC;
		}

		// åˆå§‹è®¾ç½®è¯¥æ–°ç›®å½•é¡¹ï¼šç½® i èŠ‚ç‚¹å·ä¸ºæ–°ç”³è¯·åˆ°çš„ i èŠ‚ç‚¹çš„å·ç ï¼›å¹¶ç½®é«˜é€Ÿç¼“å†²åŒºå·²ä¿®æ”¹æ ‡å¿—
		// ç„¶åé‡Šæ”¾è¯¥é«˜é€Ÿç¼“å†²åŒºï¼Œé‡Šæ”¾ç›®å½•çš„ i èŠ‚ç‚¹ï¼Œè¿”å›æ–°ç›®å½•é¡¹çš„ i èŠ‚ç‚¹æŒ‡é’ˆï¼Œé€€å‡º
		de->inode = inode->i_num;
		bh->b_dirt = 1;
		brelse(bh);
		iput(dir);
		*res_inode = inode;
		return 0;
	}

	// è‹¥ä¸Šé¢åœ¨ç›®å½•ä¸­å–æ–‡ä»¶åå¯¹åº”çš„ç›®å½•é¡¹ç»“æ„æ“ä½œæˆåŠŸ(ä¹Ÿå³ bh ä¸ä¸º NULL)
	// å–å‡ºè¯¥ç›®å½•é¡¹çš„ i èŠ‚ç‚¹å·å’Œå…¶æ‰€åœ¨çš„è®¾å¤‡å·ï¼Œå¹¶é‡Šæ”¾è¯¥é«˜é€Ÿç¼“å†²åŒºä»¥åŠç›®å½•çš„ i èŠ‚ç‚¹
	inr = de->inode;
	dev = dir->i_dev;
	brelse(bh);
	iput(dir);
	// å¦‚æœç‹¬å ä½¿ç”¨æ ‡å¿— O_EXCL ç½®ä½ï¼Œåˆ™è¿”å›æ–‡ä»¶å·²å­˜åœ¨å‡ºé”™ç ï¼Œé€€å‡º
	if (flag & O_EXCL)
		return -EEXIST;

	// å¦‚æœå–è¯¥ç›®å½•é¡¹å¯¹åº” i èŠ‚ç‚¹çš„æ“ä½œå¤±è´¥ï¼Œåˆ™è¿”å›è®¿é—®å‡ºé”™ç ï¼Œé€€å‡º
	if (!(inode = iget(dev, inr)))
		return -EACCES;

	// è‹¥è¯¥ i èŠ‚ç‚¹æ˜¯ä¸€ä¸ªç›®å½•çš„èŠ‚ç‚¹ï¼Œå¹¶ä¸”è®¿é—®æ¨¡å¼æ˜¯åªè¯»æˆ–åªå†™
	// æˆ–è€…æ²¡æœ‰è®¿é—®çš„è®¸å¯æƒé™ï¼Œåˆ™é‡Šæ”¾è¯¥ i èŠ‚ç‚¹ï¼Œè¿”å›è®¿é—®æƒé™å‡ºé”™ç ï¼Œé€€å‡º
	if ((S_ISDIR(inode->i_mode) && (flag & O_ACCMODE)) ||
		!permission(inode, ACC_MODE(flag)))
	{
		iput(inode);
		return -EPERM;
	}

	// æ›´æ–°è¯¥ i èŠ‚ç‚¹çš„è®¿é—®æ—¶é—´å­—æ®µä¸ºå½“å‰æ—¶é—´
	inode->i_atime = CURRENT_TIME;

	// å¦‚æœè®¾ç«‹äº†æˆª 0 æ ‡å¿—ï¼Œåˆ™å°†è¯¥ i èŠ‚ç‚¹çš„æ–‡ä»¶é•¿åº¦æˆªä¸º 0
	if (flag & O_TRUNC)
		truncate(inode);

	// æœ€åè¿”å›è¯¥ç›®å½•é¡¹ i èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œå¹¶è¿”å› 0ï¼ˆæˆåŠŸï¼‰
	*res_inode = inode;
	return 0;
}

// ç³»ç»Ÿè°ƒç”¨å‡½æ•° - åˆ›å»ºä¸€ä¸ªç‰¹æ®Šæ–‡ä»¶æˆ–æ™®é€šæ–‡ä»¶èŠ‚ç‚¹(node)
// åˆ›å»ºåç§°ä¸º filenameï¼Œç”± mode å’Œ dev æŒ‡å®šçš„æ–‡ä»¶ç³»ç»ŸèŠ‚ç‚¹(æ™®é€šæ–‡ä»¶ã€è®¾å¤‡ç‰¹æ®Šæ–‡ä»¶æˆ–å‘½åç®¡é“)
// å‚æ•°ï¼š
// filename - è·¯å¾„åï¼›
// mode - æŒ‡å®šä½¿ç”¨è®¸å¯ä»¥åŠæ‰€åˆ›å»ºèŠ‚ç‚¹çš„ç±»å‹ï¼›
// dev - è®¾å¤‡å·ï¼›
// è¿”å›ï¼šæˆåŠŸåˆ™è¿”å›0ï¼Œå¦åˆ™è¿”å›å‡ºé”™ç ã€‚
int sys_mknod(const char *filename, int mode, int dev)
{
	const char *basename;
	int namelen;
	struct m_inode *dir, *inode;
	struct buffer_head *bh;
	struct dir_entry *de;

	// å¦‚æœä¸æ˜¯è¶…çº§ç”¨æˆ·ï¼Œåˆ™è¿”å›è®¿é—®è®¸å¯å‡ºé”™ç 
	if (!suser())
		return -EPERM;

	// å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”è·¯å¾„åç›®å½•çš„ i èŠ‚ç‚¹ï¼Œåˆ™è¿”å›å‡ºé”™ç 
	if (!(dir = dir_namei(filename, &namelen, &basename)))
		return -ENOENT;

	// å¦‚æœæœ€é¡¶ç«¯çš„æ–‡ä»¶åé•¿åº¦ä¸º 0ï¼Œåˆ™è¯´æ˜ç»™å‡ºçš„è·¯å¾„åæœ€åæ²¡æœ‰æŒ‡å®šæ–‡ä»¶å
	// é‡Šæ”¾è¯¥ç›®å½• i èŠ‚ç‚¹ï¼Œè¿”å›å‡ºé”™ç ï¼Œé€€å‡º
	if (!namelen)
	{
		iput(dir);
		return -ENOENT;
	}

	// å¦‚æœåœ¨è¯¥ç›®å½•ä¸­æ²¡æœ‰å†™çš„æƒé™ï¼Œåˆ™é‡Šæ”¾è¯¥ç›®å½•çš„ i èŠ‚ç‚¹ï¼Œè¿”å›è®¿é—®è®¸å¯å‡ºé”™ç ï¼Œé€€å‡º
	if (!permission(dir, MAY_WRITE))
	{
		iput(dir);
		return -EPERM;
	}

	// å¦‚æœå¯¹åº”è·¯å¾„åä¸Šæœ€åçš„æ–‡ä»¶åçš„ç›®å½•é¡¹å·²ç»å­˜åœ¨ï¼Œåˆ™é‡Šæ”¾åŒ…å«è¯¥ç›®å½•é¡¹çš„é«˜é€Ÿç¼“å†²åŒº
	// é‡Šæ”¾ç›®å½•çš„ i èŠ‚ç‚¹ï¼Œè¿”å›æ–‡ä»¶å·²ç»å­˜åœ¨å‡ºé”™ç ï¼Œé€€å‡º
	bh = find_entry(&dir, basename, namelen, &de);
	if (bh)
	{
		brelse(bh);
		iput(dir);
		return -EEXIST;
	}

	// ç”³è¯·ä¸€ä¸ªæ–°çš„ i èŠ‚ç‚¹ï¼Œå¦‚æœä¸æˆåŠŸï¼Œåˆ™é‡Šæ”¾ç›®å½•çš„ i èŠ‚ç‚¹ï¼Œè¿”å›æ— ç©ºé—´å‡ºé”™ç ï¼Œé€€å‡º
	inode = new_inode(dir->i_dev);
	if (!inode)
	{
		iput(dir);
		return -ENOSPC;
	}

	// è®¾ç½®è¯¥ i èŠ‚ç‚¹çš„å±æ€§æ¨¡å¼ï¼Œå¦‚æœè¦åˆ›å»ºçš„æ˜¯å—è®¾å¤‡æ–‡ä»¶æˆ–è€…æ˜¯å­—ç¬¦è®¾å¤‡æ–‡ä»¶
	// åˆ™ä»¤ i èŠ‚ç‚¹çš„ç›´æ¥å—æŒ‡é’ˆ 0 ç­‰äºè®¾å¤‡å·
	inode->i_mode = mode;
	if (S_ISBLK(mode) || S_ISCHR(mode))
		inode->i_zone[0] = dev;

	// è®¾ç½®è¯¥ i èŠ‚ç‚¹çš„ä¿®æ”¹æ—¶é—´ã€è®¿é—®æ—¶é—´ä¸ºå½“å‰æ—¶é—´
	inode->i_mtime = inode->i_atime = CURRENT_TIME;
	inode->i_dirt = 1;

	// åœ¨ç›®å½•ä¸­æ–°æ·»åŠ ä¸€ä¸ªç›®å½•é¡¹ï¼Œå¦‚æœå¤±è´¥(åŒ…å«è¯¥ç›®å½•é¡¹çš„é«˜é€Ÿç¼“å†²åŒºæŒ‡é’ˆä¸º NULL)
	// åˆ™é‡Šæ”¾ç›®å½•çš„ i èŠ‚ç‚¹ï¼›æ‰€ç”³è¯·çš„ i èŠ‚ç‚¹å¼•ç”¨è¿æ¥è®¡æ•°å¤ä½ï¼Œå¹¶é‡Šæ”¾è¯¥ i èŠ‚ç‚¹ï¼Œè¿”å›å‡ºé”™ç ï¼Œé€€å‡º
	bh = add_entry(dir, basename, namelen, &de);
	if (!bh)
	{
		iput(dir);
		inode->i_nlinks = 0;
		iput(inode);
		return -ENOSPC;
	}

	// ä»¤è¯¥ç›®å½•é¡¹çš„ i èŠ‚ç‚¹å­—æ®µç­‰äºæ–° i èŠ‚ç‚¹å·
	// ç½®é«˜é€Ÿç¼“å†²åŒºå·²ä¿®æ”¹æ ‡å¿—ï¼Œé‡Šæ”¾ç›®å½•å’Œæ–°çš„ i èŠ‚ç‚¹
	// é‡Šæ”¾é«˜é€Ÿç¼“å†²åŒºï¼Œæœ€åè¿”å› 0(æˆåŠŸ)
	de->inode = inode->i_num;
	bh->b_dirt = 1;
	iput(dir);
	iput(inode);
	brelse(bh);
	return 0;
}

// ç³»ç»Ÿè°ƒç”¨å‡½æ•° - åˆ›å»ºç›®å½•
// å‚æ•°ï¼špathname - è·¯å¾„åï¼›mode - ç›®å½•ä½¿ç”¨çš„æƒé™å±æ€§ï¼›
// è¿”å›ï¼šæˆåŠŸåˆ™è¿”å› 0ï¼Œå¦åˆ™è¿”å›å‡ºé”™ç 
int sys_mkdir(const char *pathname, int mode)
{
	const char *basename;
	int namelen;
	struct m_inode *dir, *inode;
	struct buffer_head *bh, *dir_block;
	struct dir_entry *de;

	// å¦‚æœä¸æ˜¯è¶…çº§ç”¨æˆ·ï¼Œåˆ™è¿”å›è®¿é—®è®¸å¯å‡ºé”™ç 
	if (!suser())
		return -EPERM;

	// å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”è·¯å¾„åç›®å½•çš„ i èŠ‚ç‚¹ï¼Œåˆ™è¿”å›å‡ºé”™ç 
	if (!(dir = dir_namei(pathname, &namelen, &basename)))
		return -ENOENT;

	// å¦‚æœæœ€é¡¶ç«¯çš„æ–‡ä»¶åé•¿åº¦ä¸º 0ï¼Œåˆ™è¯´æ˜ç»™å‡ºçš„è·¯å¾„åæœ€åæ²¡æœ‰æŒ‡å®šæ–‡ä»¶å
	// é‡Šæ”¾è¯¥ç›®å½• i èŠ‚ç‚¹ï¼Œè¿”å›å‡ºé”™ç ï¼Œé€€å‡º
	if (!namelen)
	{
		iput(dir);
		return -ENOENT;
	}

	// å¦‚æœåœ¨è¯¥ç›®å½•ä¸­æ²¡æœ‰å†™çš„æƒé™ï¼Œåˆ™é‡Šæ”¾è¯¥ç›®å½•çš„ i èŠ‚ç‚¹ï¼Œè¿”å›è®¿é—®è®¸å¯å‡ºé”™ç ï¼Œé€€å‡º
	if (!permission(dir, MAY_WRITE))
	{
		iput(dir);
		return -EPERM;
	}

	// å¦‚æœå¯¹åº”è·¯å¾„åä¸Šæœ€åçš„æ–‡ä»¶åçš„ç›®å½•é¡¹å·²ç»å­˜åœ¨
	// åˆ™é‡Šæ”¾åŒ…å«è¯¥ç›®å½•é¡¹çš„é«˜é€Ÿç¼“å†²åŒºï¼Œé‡Šæ”¾ç›®å½•çš„ i èŠ‚ç‚¹ï¼Œè¿”å›æ–‡ä»¶å·²ç»å­˜åœ¨å‡ºé”™ç ï¼Œé€€å‡º
	bh = find_entry(&dir, basename, namelen, &de);
	if (bh)
	{
		brelse(bh);
		iput(dir);
		return -EEXIST;
	}

	// ç”³è¯·ä¸€ä¸ªæ–°çš„ i èŠ‚ç‚¹ï¼Œå¦‚æœä¸æˆåŠŸï¼Œåˆ™é‡Šæ”¾ç›®å½•çš„ i èŠ‚ç‚¹ï¼Œè¿”å›æ— ç©ºé—´å‡ºé”™ç ï¼Œé€€å‡º
	inode = new_inode(dir->i_dev);
	if (!inode)
	{
		iput(dir);
		return -ENOSPC;
	}

	// ç½®è¯¥æ–° i èŠ‚ç‚¹å¯¹åº”çš„æ–‡ä»¶é•¿åº¦ä¸º32(ä¸€ä¸ªç›®å½•é¡¹çš„å¤§å°)
	// ç½®èŠ‚ç‚¹å·²ä¿®æ”¹æ ‡å¿—ï¼Œä»¥åŠèŠ‚ç‚¹çš„ä¿®æ”¹æ—¶é—´å’Œè®¿é—®æ—¶é—´
	inode->i_size = 32;
	inode->i_dirt = 1;
	inode->i_mtime = inode->i_atime = CURRENT_TIME;

	// ä¸ºè¯¥ i èŠ‚ç‚¹ç”³è¯·ä¸€ç£ç›˜å—ï¼Œå¹¶ä»¤èŠ‚ç‚¹ç¬¬ä¸€ä¸ªç›´æ¥å—æŒ‡é’ˆç­‰äºè¯¥å—å·
	// å¦‚æœç”³è¯·å¤±è´¥ï¼Œåˆ™é‡Šæ”¾å¯¹åº”ç›®å½•çš„ i èŠ‚ç‚¹ï¼›
	// å¤ä½æ–°ç”³è¯·çš„ i èŠ‚ç‚¹è¿æ¥è®¡æ•°ï¼›é‡Šæ”¾è¯¥æ–°çš„ i èŠ‚ç‚¹ï¼Œè¿”å›æ²¡æœ‰ç©ºé—´å‡ºé”™ç ï¼Œé€€å‡º
	if (!(inode->i_zone[0] = new_block(inode->i_dev)))
	{
		iput(dir);
		inode->i_nlinks--;
		iput(inode);
		return -ENOSPC;
	}

	// ç½®è¯¥æ–°çš„ i èŠ‚ç‚¹å·²ä¿®æ”¹æ ‡å¿—
	inode->i_dirt = 1;

	// è¯»æ–°ç”³è¯·çš„ç£ç›˜å—ï¼Œè‹¥å‡ºé”™ï¼Œåˆ™é‡Šæ”¾å¯¹åº”ç›®å½•çš„ i èŠ‚ç‚¹ï¼›
	// é‡Šæ”¾ç”³è¯·çš„ç£ç›˜å—ï¼›
	// å¤ä½æ–°ç”³è¯·çš„i èŠ‚ç‚¹è¿æ¥è®¡æ•°ï¼›
	// é‡Šæ”¾è¯¥æ–°çš„ i èŠ‚ç‚¹ï¼Œè¿”å›æ²¡æœ‰ç©ºé—´å‡ºé”™ç ï¼Œé€€å‡º
	if (!(dir_block = bread(inode->i_dev, inode->i_zone[0])))
	{
		iput(dir);
		free_block(inode->i_dev, inode->i_zone[0]);
		inode->i_nlinks--;
		iput(inode);
		return -ERROR;
	}

	// ä»¤ de æŒ‡å‘ç›®å½•é¡¹æ•°æ®å—
	// ç½®è¯¥ç›®å½•é¡¹çš„ i èŠ‚ç‚¹å·å­—æ®µç­‰äºæ–°ç”³è¯·çš„ i èŠ‚ç‚¹å·ï¼Œåå­—å­—æ®µç­‰äº "."
	de = (struct dir_entry *)dir_block->b_data;
	de->inode = inode->i_num;
	strcpy(de->name, ".");

	// ç„¶å de æŒ‡å‘ä¸‹ä¸€ä¸ªç›®å½•é¡¹ç»“æ„ï¼Œè¯¥ç»“æ„ç”¨äºå­˜æ”¾ä¸Šçº§ç›®å½•çš„èŠ‚ç‚¹å·å’Œåå­— ".."
	de++;
	de->inode = dir->i_num;
	strcpy(de->name, "..");
	inode->i_nlinks = 2;

	// ç„¶åè®¾ç½®è¯¥é«˜é€Ÿç¼“å†²åŒºå·²ä¿®æ”¹æ ‡å¿—ï¼Œå¹¶é‡Šæ”¾è¯¥ç¼“å†²åŒº
	dir_block->b_dirt = 1;
	brelse(dir_block);

	// åˆå§‹åŒ–è®¾ç½®æ–° i èŠ‚ç‚¹çš„æ¨¡å¼å­—æ®µï¼Œå¹¶ç½®è¯¥ i èŠ‚ç‚¹å·²ä¿®æ”¹æ ‡å¿—
	inode->i_mode = I_DIRECTORY | (mode & 0777 & ~current->umask);
	inode->i_dirt = 1;

	// åœ¨ç›®å½•ä¸­æ–°æ·»åŠ ä¸€ä¸ªç›®å½•é¡¹
	// å¦‚æœå¤±è´¥(åŒ…å«è¯¥ç›®å½•é¡¹çš„é«˜é€Ÿç¼“å†²åŒºæŒ‡é’ˆä¸ºNULL)ï¼Œåˆ™é‡Šæ”¾ç›®å½•çš„ i èŠ‚ç‚¹ï¼›
	// æ‰€ç”³è¯·çš„ i èŠ‚ç‚¹å¼•ç”¨è¿æ¥è®¡æ•°å¤ä½ï¼Œå¹¶é‡Šæ”¾è¯¥ i èŠ‚ç‚¹ï¼Œè¿”å›å‡ºé”™ç ï¼Œé€€å‡ºï¼›
	bh = add_entry(dir, basename, namelen, &de);
	if (!bh)
	{
		iput(dir);
		free_block(inode->i_dev, inode->i_zone[0]);
		inode->i_nlinks = 0;
		iput(inode);
		return -ENOSPC;
	}

	// ä»¤è¯¥ç›®å½•é¡¹çš„ i èŠ‚ç‚¹å­—æ®µç­‰äºæ–° i èŠ‚ç‚¹å·ï¼Œç½®é«˜é€Ÿç¼“å†²åŒºå·²ä¿®æ”¹æ ‡å¿—
	// é‡Šæ”¾ç›®å½•å’Œæ–°çš„ i èŠ‚ç‚¹ï¼Œé‡Šæ”¾é«˜é€Ÿç¼“å†²åŒºï¼Œæœ€åè¿”å› 0(æˆåŠŸ)
	de->inode = inode->i_num;
	bh->b_dirt = 1;
	dir->i_nlinks++;
	dir->i_dirt = 1;
	iput(dir);
	iput(inode);
	brelse(bh);
	return 0;
}

// ç”¨äºæ£€æŸ¥æŒ‡å®šçš„ç›®å½•æ˜¯å¦ä¸ºç©ºçš„å­ç¨‹åº(ç”¨äº rmdir ç³»ç»Ÿè°ƒç”¨å‡½æ•°)

// æ£€æŸ¥æŒ‡å®šç›®å½•æ˜¯å¦æ˜¯ç©ºçš„
// å‚æ•°ï¼šinode - æŒ‡å®šç›®å½•çš„ i èŠ‚ç‚¹æŒ‡é’ˆ
// è¿”å›ï¼š1 - æ˜¯ç©ºçš„ï¼›0 - ä¸ç©º
static int empty_dir(struct m_inode *inode)
{
	int nr, block;
	int len;
	struct buffer_head *bh;
	struct dir_entry *de;

	// è®¡ç®—æŒ‡å®šç›®å½•ä¸­ç°æœ‰ç›®å½•é¡¹çš„ä¸ªæ•°
	// (åº”è¯¥èµ·ç æœ‰ 2 ä¸ªï¼Œå³ "." å’Œ ".." ä¸¤ä¸ªæ–‡ä»¶ç›®å½•é¡¹)
	len = inode->i_size / sizeof(struct dir_entry);

	// å¦‚æœç›®å½•é¡¹ä¸ªæ•°å°‘äº 2 ä¸ª
	// æˆ–è€…è¯¥ç›®å½• i èŠ‚ç‚¹çš„ç¬¬ 1 ä¸ªç›´æ¥å—æ²¡æœ‰æŒ‡å‘ä»»ä½•ç£ç›˜å—å·
	// æˆ–è€…ç›¸åº”ç£ç›˜å—è¯»ä¸å‡ºï¼Œåˆ™æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯ è®¾å¤‡ dev ä¸Šç›®å½•é”™ï¼Œè¿”å› 0(å¤±è´¥)
	if (len < 2 || !inode->i_zone[0] ||
		!(bh = bread(inode->i_dev, inode->i_zone[0])))
	{
		printk("warning - bad directory on dev %04x\n", inode->i_dev);
		return 0;
	}

	// è®© de æŒ‡å‘å«æœ‰è¯»å‡ºç£ç›˜å—æ•°æ®çš„é«˜é€Ÿç¼“å†²åŒºä¸­ç¬¬ 1 é¡¹ç›®å½•é¡¹
	de = (struct dir_entry *)bh->b_data;

	// å¦‚æœç¬¬ 1 ä¸ªç›®å½•é¡¹çš„ i èŠ‚ç‚¹å·å­—æ®µå€¼ä¸ç­‰äºè¯¥ç›®å½•çš„ i èŠ‚ç‚¹å·
	// æˆ–è€…ç¬¬ 2 ä¸ªç›®å½•é¡¹çš„ i èŠ‚ç‚¹å·å­—æ®µä¸ºé›¶
	// æˆ–è€…ä¸¤ä¸ªç›®å½•é¡¹çš„åå­—å­—æ®µä¸åˆ†åˆ«ç­‰äº "." å’Œ ".."
	// åˆ™æ˜¾ç¤ºå‡ºé”™è­¦å‘Šä¿¡æ¯â€œ è®¾å¤‡ dev ä¸Šç›®å½•é”™â€ï¼Œå¹¶è¿”å› 0
	if (de[0].inode != inode->i_num || !de[1].inode ||
		strcmp(".", de[0].name) || strcmp("..", de[1].name))
	{
		printk("warning - bad directory on dev %04x\n", inode->i_dev);
		return 0;
	}
	// ä»¤ nr ç­‰äºç›®å½•é¡¹åºå·ï¼›de æŒ‡å‘ç¬¬ä¸‰ä¸ªç›®å½•é¡¹
	nr = 2;
	de += 2;

	// å¾ªç¯æ£€æµ‹è¯¥ç›®å½•ä¸­æ‰€æœ‰çš„ç›®å½•é¡¹(len - 2 ä¸ª)
	// çœ‹æœ‰æ²¡æœ‰ç›®å½•é¡¹çš„ i èŠ‚ç‚¹å·å­—æ®µä¸ä¸º 0(è¢«ä½¿ç”¨)
	while (nr < len)
	{
		// å¦‚æœè¯¥å—ç£ç›˜å—ä¸­çš„ç›®å½•é¡¹å·²ç»æ£€æµ‹å®Œï¼Œåˆ™é‡Šæ”¾è¯¥ç£ç›˜å—çš„é«˜é€Ÿç¼“å†²åŒº
		// è¯»å–ä¸‹ä¸€å—å«æœ‰ç›®å½•é¡¹çš„ç£ç›˜å—
		// è‹¥ç›¸åº”å—æ²¡æœ‰ä½¿ç”¨(æˆ–å·²ç»ä¸ç”¨ï¼Œå¦‚æ–‡ä»¶å·²ç»åˆ é™¤ç­‰)
		// åˆ™ç»§ç»­è¯»ä¸‹ä¸€å—ï¼Œè‹¥è¯»ä¸å‡ºï¼Œåˆ™å‡ºé”™ï¼Œè¿”å› 0
		// å¦åˆ™è®© de æŒ‡å‘è¯»å‡ºå—çš„é¦–ä¸ªç›®å½•é¡¹
		if ((void *)de >= (void *)(bh->b_data + BLOCK_SIZE))
		{
			brelse(bh);
			block = bmap(inode, nr / DIR_ENTRIES_PER_BLOCK);
			if (!block)
			{
				nr += DIR_ENTRIES_PER_BLOCK;
				continue;
			}
			if (!(bh = bread(inode->i_dev, block)))
				return 0;
			de = (struct dir_entry *)bh->b_data;
		}

		// å¦‚æœè¯¥ç›®å½•é¡¹çš„ i èŠ‚ç‚¹å·å­—æ®µä¸ç­‰äº 0ï¼Œ
		// åˆ™è¡¨ç¤ºè¯¥ç›®å½•é¡¹ç›®å‰æ­£è¢«ä½¿ç”¨ï¼Œåˆ™é‡Šæ”¾è¯¥é«˜é€Ÿç¼“å†²åŒºï¼Œè¿”å› 0ï¼Œé€€å‡º
		if (de->inode)
		{
			brelse(bh);
			return 0;
		}
		// å¦åˆ™ï¼Œè‹¥è¿˜æ²¡æœ‰æŸ¥è¯¢å®Œè¯¥ç›®å½•ä¸­çš„æ‰€æœ‰ç›®å½•é¡¹ï¼Œåˆ™ç»§ç»­æ£€æµ‹
		de++;
		nr++;
	}

	// åˆ°è¿™é‡Œè¯´æ˜è¯¥ç›®å½•ä¸­æ²¡æœ‰æ‰¾åˆ°å·²ç”¨çš„ç›®å½•é¡¹(å½“ç„¶é™¤äº†å¤´ä¸¤ä¸ªä»¥å¤–)ï¼Œåˆ™é‡Šæ”¾ç¼“å†²åŒºï¼Œè¿”å› 1
	brelse(bh);
	return 1;
}

// ç³»ç»Ÿè°ƒç”¨å‡½æ•° - åˆ é™¤æŒ‡å®šåç§°çš„ç›®å½•
// å‚æ•°ï¼š name - ç›®å½•å(è·¯å¾„å)
// è¿”å›ï¼šè¿”å› 0 è¡¨ç¤ºæˆåŠŸï¼Œå¦åˆ™è¿”å›å‡ºé”™å·
int sys_rmdir(const char *name)
{
	const char *basename;
	int namelen;
	struct m_inode *dir, *inode;
	struct buffer_head *bh;
	struct dir_entry *de;

	// å¦‚æœä¸æ˜¯è¶…çº§ç”¨æˆ·ï¼Œåˆ™è¿”å›è®¿é—®è®¸å¯å‡ºé”™ç 
	if (!suser())
		return -EPERM;

	// å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”è·¯å¾„åç›®å½•çš„ i èŠ‚ç‚¹ï¼Œåˆ™è¿”å›å‡ºé”™ç 
	if (!(dir = dir_namei(name, &namelen, &basename)))
		return -ENOENT;

	// å¦‚æœæœ€é¡¶ç«¯çš„æ–‡ä»¶åé•¿åº¦ä¸º 0ï¼Œåˆ™è¯´æ˜ç»™å‡ºçš„è·¯å¾„åæœ€åæ²¡æœ‰æŒ‡å®šæ–‡ä»¶å
	// é‡Šæ”¾è¯¥ç›®å½• i èŠ‚ç‚¹ï¼Œè¿”å›å‡ºé”™ç ï¼Œé€€å‡º
	if (!namelen)
	{
		iput(dir);
		return -ENOENT;
	}

	// å¦‚æœåœ¨è¯¥ç›®å½•ä¸­æ²¡æœ‰å†™çš„æƒé™ï¼Œåˆ™é‡Šæ”¾è¯¥ç›®å½•çš„ i èŠ‚ç‚¹ï¼Œè¿”å›è®¿é—®è®¸å¯å‡ºé”™ç ï¼Œé€€å‡º
	if (!permission(dir, MAY_WRITE))
	{
		iput(dir);
		return -EPERM;
	}

	// å¦‚æœå¯¹åº”è·¯å¾„åä¸Šæœ€åçš„æ–‡ä»¶åçš„ç›®å½•é¡¹ä¸å­˜åœ¨
	// åˆ™é‡Šæ”¾åŒ…å«è¯¥ç›®å½•é¡¹çš„é«˜é€Ÿç¼“å†²åŒº
	// é‡Šæ”¾ç›®å½•çš„ i èŠ‚ç‚¹ï¼Œè¿”å›æ–‡ä»¶å·²ç»å­˜åœ¨å‡ºé”™ç ï¼Œé€€å‡º
	// å¦åˆ™ dir æ˜¯åŒ…å«è¦è¢«åˆ é™¤ç›®å½•åçš„ç›®å½• i èŠ‚ç‚¹
	// de æ˜¯è¦è¢«åˆ é™¤ç›®å½•çš„ç›®å½•é¡¹ç»“æ„
	bh = find_entry(&dir, basename, namelen, &de);
	if (!bh)
	{
		iput(dir);
		return -ENOENT;
	}

	// å–è¯¥ç›®å½•é¡¹æŒ‡æ˜çš„ i èŠ‚ç‚¹
	// è‹¥å‡ºé”™åˆ™é‡Šæ”¾ç›®å½•çš„ i èŠ‚ç‚¹ï¼Œå¹¶é‡Šæ”¾å«æœ‰ç›®å½•é¡¹çš„é«˜é€Ÿç¼“å†²åŒºï¼Œè¿”å›å‡ºé”™å·
	if (!(inode = iget(dir->i_dev, de->inode)))
	{
		iput(dir);
		brelse(bh);
		return -EPERM;
	}

	// è‹¥è¯¥ç›®å½•è®¾ç½®äº†å—é™åˆ é™¤æ ‡å¿—
	// å¹¶ä¸”è¿›ç¨‹çš„æœ‰æ•ˆç”¨æˆ· id ä¸ç­‰äºè¯¥ i èŠ‚ç‚¹çš„ç”¨æˆ· idï¼Œåˆ™è¡¨ç¤ºæ²¡æœ‰æƒé™åˆ é™¤è¯¥ç›®å½•
	// äºæ˜¯é‡Šæ”¾åŒ…å«è¦åˆ é™¤ç›®å½•åçš„ç›®å½• i èŠ‚ç‚¹å’Œè¯¥è¦åˆ é™¤ç›®å½•çš„ i èŠ‚ç‚¹
	// é‡Šæ”¾é«˜é€Ÿç¼“å†²åŒºï¼Œè¿”å›å‡ºé”™ç 
	if ((dir->i_mode & S_ISVTX) && current->euid &&
		inode->i_uid != current->euid)
	{
		iput(dir);
		iput(inode);
		brelse(bh);
		return -EPERM;
	}

	// å¦‚æœè¦è¢«åˆ é™¤çš„ç›®å½•é¡¹çš„ i èŠ‚ç‚¹çš„è®¾å¤‡å·ï¼Œä¸ç­‰äºåŒ…å«è¯¥ç›®å½•é¡¹çš„ç›®å½•çš„è®¾å¤‡å·
	// æˆ–è€…è¯¥è¢«åˆ é™¤ç›®å½•çš„å¼•ç”¨è¿æ¥è®¡æ•°å¤§äº 1(è¡¨ç¤ºæœ‰ç¬¦å·è¿æ¥ç­‰)ï¼Œåˆ™ä¸èƒ½åˆ é™¤è¯¥ç›®å½•
	// äºæ˜¯é‡Šæ”¾åŒ…å«è¦åˆ é™¤ç›®å½•åçš„ç›®å½• i èŠ‚ç‚¹å’Œè¯¥è¦åˆ é™¤ç›®å½•çš„ i èŠ‚ç‚¹ï¼Œé‡Šæ”¾é«˜é€Ÿç¼“å†²åŒºï¼Œè¿”å›å‡ºé”™ç 
	if (inode->i_dev != dir->i_dev || inode->i_count > 1)
	{
		iput(dir);
		iput(inode);
		brelse(bh);
		return -EPERM;
	}

	// å¦‚æœè¦è¢«åˆ é™¤ç›®å½•çš„ç›®å½•é¡¹ i èŠ‚ç‚¹çš„èŠ‚ç‚¹å·ï¼Œç­‰äºåŒ…å«è¯¥éœ€åˆ é™¤ç›®å½•çš„ i èŠ‚ç‚¹å·
	// åˆ™è¡¨ç¤ºè¯•å›¾åˆ é™¤"." ç›®å½•
	// äºæ˜¯é‡Šæ”¾åŒ…å«è¦åˆ é™¤ç›®å½•åçš„ç›®å½• i èŠ‚ç‚¹å’Œè¯¥è¦åˆ é™¤ç›®å½•çš„i èŠ‚ç‚¹
	// é‡Šæ”¾é«˜é€Ÿç¼“å†²åŒºï¼Œè¿”å›å‡ºé”™ç 
	if (inode == dir)
	{ /* we may not delete ".", but "../dir" is ok */
		// æˆ‘ä»¬ä¸å¯ä»¥åˆ é™¤ "."ï¼Œä½†å¯ä»¥åˆ é™¤ "../dir"
		iput(inode);
		iput(dir);
		brelse(bh);
		return -EPERM;
	}

	// è‹¥è¦è¢«åˆ é™¤çš„ç›®å½•çš„ i èŠ‚ç‚¹çš„å±æ€§è¡¨æ˜è¿™ä¸æ˜¯ä¸€ä¸ªç›®å½•
	// åˆ™é‡Šæ”¾åŒ…å«è¦åˆ é™¤ç›®å½•åçš„ç›®å½• i èŠ‚ç‚¹å’Œè¯¥è¦åˆ é™¤ç›®å½•çš„ i èŠ‚ç‚¹ï¼Œé‡Šæ”¾é«˜é€Ÿç¼“å†²åŒºï¼Œè¿”å›å‡ºé”™ç 
	if (!S_ISDIR(inode->i_mode))
	{
		iput(inode);
		iput(dir);
		brelse(bh);
		return -ENOTDIR;
	}

	// è‹¥è¯¥éœ€è¢«åˆ é™¤çš„ç›®å½•ä¸ç©º
	// åˆ™é‡Šæ”¾åŒ…å«è¦åˆ é™¤ç›®å½•åçš„ç›®å½• i èŠ‚ç‚¹å’Œè¯¥è¦åˆ é™¤ç›®å½•çš„ i èŠ‚ç‚¹ï¼Œé‡Šæ”¾é«˜é€Ÿç¼“å†²åŒºï¼Œè¿”å›å‡ºé”™ç 
	if (!empty_dir(inode))
	{
		iput(inode);
		iput(dir);
		brelse(bh);
		return -ENOTEMPTY;
	}

	// è‹¥è¯¥éœ€è¢«åˆ é™¤ç›®å½•çš„ i èŠ‚ç‚¹çš„è¿æ¥æ•°ä¸ç­‰äº 2ï¼Œåˆ™æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
	if (inode->i_nlinks != 2)
		printk("empty directory has nlink!=2 (%d)", inode->i_nlinks);

	// ç½®è¯¥éœ€è¢«åˆ é™¤ç›®å½•çš„ç›®å½•é¡¹çš„ i èŠ‚ç‚¹å·å­—æ®µä¸º 0
	// è¡¨ç¤ºè¯¥ç›®å½•é¡¹ä¸å†ä½¿ç”¨ï¼Œå¹¶ç½®å«æœ‰è¯¥ç›®å½•é¡¹çš„é«˜é€Ÿç¼“å†²åŒºå·²ä¿®æ”¹æ ‡å¿—ï¼Œå¹¶é‡Šæ”¾è¯¥ç¼“å†²åŒº
	de->inode = 0;
	bh->b_dirt = 1;
	brelse(bh);

	// ç½®è¢«åˆ é™¤ç›®å½•çš„ i èŠ‚ç‚¹çš„è¿æ¥æ•°ä¸º 0ï¼Œå¹¶ç½® i èŠ‚ç‚¹å·²ä¿®æ”¹æ ‡å¿—
	inode->i_nlinks = 0;
	inode->i_dirt = 1;

	// å°†åŒ…å«è¢«åˆ é™¤ç›®å½•åçš„ç›®å½•çš„ i èŠ‚ç‚¹å¼•ç”¨è®¡æ•°å‡ 1
	// ä¿®æ”¹å…¶æ”¹å˜æ—¶é—´å’Œä¿®æ”¹æ—¶é—´ä¸ºå½“å‰æ—¶é—´ï¼Œå¹¶ç½®è¯¥èŠ‚ç‚¹å·²ä¿®æ”¹æ ‡å¿—
	dir->i_nlinks--;
	dir->i_ctime = dir->i_mtime = CURRENT_TIME;
	dir->i_dirt = 1;

	// æœ€åé‡Šæ”¾åŒ…å«è¦åˆ é™¤ç›®å½•åçš„ç›®å½• i èŠ‚ç‚¹å’Œè¯¥è¦åˆ é™¤ç›®å½•çš„ i èŠ‚ç‚¹ï¼Œè¿”å› 0(æˆåŠŸ)
	iput(dir);
	iput(inode);
	return 0;
}

// ç³»ç»Ÿè°ƒç”¨å‡½æ•° - åˆ é™¤æ–‡ä»¶åä»¥åŠå¯èƒ½ä¹Ÿåˆ é™¤å…¶ç›¸å…³çš„æ–‡ä»¶
// ä»æ–‡ä»¶ç³»ç»Ÿåˆ é™¤ä¸€ä¸ªåå­—ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªæ–‡ä»¶çš„æœ€åä¸€ä¸ªè¿æ¥ï¼Œå¹¶ä¸”æ²¡æœ‰è¿›ç¨‹æ­£æ‰“å¼€è¯¥æ–‡ä»¶
// åˆ™è¯¥æ–‡ä»¶ä¹Ÿå°†è¢«åˆ é™¤ï¼Œå¹¶é‡Šæ”¾æ‰€å ç”¨çš„è®¾å¤‡ç©ºé—´
// å‚æ•°ï¼šname - æ–‡ä»¶å
// è¿”å›ï¼šæˆåŠŸåˆ™è¿”å› 0ï¼Œå¦åˆ™è¿”å›å‡ºé”™å·
int sys_unlink(const char *name)
{
	const char *basename;
	int namelen;
	struct m_inode *dir, *inode;
	struct buffer_head *bh;
	struct dir_entry *de;

	// å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”è·¯å¾„åç›®å½•çš„ i èŠ‚ç‚¹ï¼Œåˆ™è¿”å›å‡ºé”™ç 
	if (!(dir = dir_namei(name, &namelen, &basename)))
		return -ENOENT;

	// å¦‚æœæœ€é¡¶ç«¯çš„æ–‡ä»¶åé•¿åº¦ä¸º 0ï¼Œåˆ™è¯´æ˜ç»™å‡ºçš„è·¯å¾„åæœ€åæ²¡æœ‰æŒ‡å®šæ–‡ä»¶å
	// é‡Šæ”¾è¯¥ç›®å½• i èŠ‚ç‚¹ï¼Œè¿”å›å‡ºé”™ç ï¼Œé€€å‡º
	if (!namelen)
	{
		iput(dir);
		return -ENOENT;
	}

	// å¦‚æœåœ¨è¯¥ç›®å½•ä¸­æ²¡æœ‰å†™çš„æƒé™ï¼Œåˆ™é‡Šæ”¾è¯¥ç›®å½•çš„ i èŠ‚ç‚¹ï¼Œè¿”å›è®¿é—®è®¸å¯å‡ºé”™ç ï¼Œé€€å‡º
	if (!permission(dir, MAY_WRITE))
	{
		iput(dir);
		return -EPERM;
	}

	// å¦‚æœå¯¹åº”è·¯å¾„åä¸Šæœ€åçš„æ–‡ä»¶åçš„ç›®å½•é¡¹ä¸å­˜åœ¨ï¼Œåˆ™é‡Šæ”¾åŒ…å«è¯¥ç›®å½•é¡¹çš„é«˜é€Ÿç¼“å†²åŒº
	// é‡Šæ”¾ç›®å½•çš„ i èŠ‚ç‚¹ï¼Œè¿”å›æ–‡ä»¶å·²ç»å­˜åœ¨å‡ºé”™ç ï¼Œé€€å‡º
	// å¦åˆ™ dir æ˜¯åŒ…å«è¦è¢«åˆ é™¤ç›®å½•åçš„ç›®å½• i èŠ‚ç‚¹
	// de æ˜¯è¦è¢«åˆ é™¤ç›®å½•çš„ç›®å½•é¡¹ç»“æ„
	bh = find_entry(&dir, basename, namelen, &de);
	if (!bh)
	{
		iput(dir);
		return -ENOENT;
	}

	// å–è¯¥ç›®å½•é¡¹æŒ‡æ˜çš„ i èŠ‚ç‚¹ï¼Œè‹¥å‡ºé”™åˆ™é‡Šæ”¾ç›®å½•çš„ i èŠ‚ç‚¹
	// å¹¶é‡Šæ”¾å«æœ‰ç›®å½•é¡¹çš„é«˜é€Ÿç¼“å†²åŒºï¼Œè¿”å›å‡ºé”™å·
	if (!(inode = iget(dir->i_dev, de->inode)))
	{
		iput(dir);
		brelse(bh);
		return -ENOENT;
	}

	// å¦‚æœè¯¥ç›®å½•è®¾ç½®äº†å—é™åˆ é™¤æ ‡å¿—å¹¶ä¸”ç”¨æˆ·ä¸æ˜¯è¶…çº§ç”¨æˆ·
	// å¹¶ä¸”è¿›ç¨‹çš„æœ‰æ•ˆç”¨æˆ· id ä¸ç­‰äºè¢«åˆ é™¤æ–‡ä»¶å i èŠ‚ç‚¹çš„ç”¨æˆ· id
	// å¹¶ä¸”è¿›ç¨‹çš„æœ‰æ•ˆç”¨æˆ· id ä¹Ÿä¸ç­‰äºç›®å½• i èŠ‚ç‚¹çš„ç”¨æˆ· id
	// åˆ™æ²¡æœ‰æƒé™åˆ é™¤è¯¥æ–‡ä»¶å
	// åˆ™é‡Šæ”¾è¯¥ç›®å½• i èŠ‚ç‚¹å’Œè¯¥æ–‡ä»¶åç›®å½•é¡¹çš„ i èŠ‚ç‚¹
	// é‡Šæ”¾åŒ…å«è¯¥ç›®å½•é¡¹çš„ç¼“å†²åŒºï¼Œè¿”å›å‡ºé”™å·
	if ((dir->i_mode & S_ISVTX) && !suser() &&
		current->euid != inode->i_uid &&
		current->euid != dir->i_uid)
	{
		iput(dir);
		iput(inode);
		brelse(bh);
		return -EPERM;
	}

	// å¦‚æœè¯¥æŒ‡å®šæ–‡ä»¶åæ˜¯ä¸€ä¸ªç›®å½•ï¼Œåˆ™ä¹Ÿä¸èƒ½åˆ é™¤
	// é‡Šæ”¾è¯¥ç›®å½• i èŠ‚ç‚¹å’Œè¯¥æ–‡ä»¶åç›®å½•é¡¹çš„ i èŠ‚ç‚¹
	// é‡Šæ”¾åŒ…å«è¯¥ç›®å½•é¡¹çš„ç¼“å†²åŒºï¼Œè¿”å›å‡ºé”™å·
	if (S_ISDIR(inode->i_mode))
	{
		iput(inode);
		iput(dir);
		brelse(bh);
		return -EPERM;
	}

	// å¦‚æœè¯¥ i èŠ‚ç‚¹çš„è¿æ¥æ•°å·²ç»ä¸º 0ï¼Œåˆ™æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯ï¼Œä¿®æ­£å…¶ä¸º 1
	if (!inode->i_nlinks)
	{
		printk("Deleting nonexistent file (%04x:%d), %d\n",
			   inode->i_dev, inode->i_num, inode->i_nlinks);
		inode->i_nlinks = 1;
	}

	// å°†è¯¥æ–‡ä»¶åçš„ç›®å½•é¡¹ä¸­çš„ i èŠ‚ç‚¹å·å­—æ®µç½®ä¸º 0
	// è¡¨ç¤ºé‡Šæ”¾è¯¥ç›®å½•é¡¹ï¼Œå¹¶è®¾ç½®åŒ…å«è¯¥ç›®å½•é¡¹çš„ç¼“å†²åŒºå·²ä¿®æ”¹æ ‡å¿—ï¼Œé‡Šæ”¾è¯¥é«˜é€Ÿç¼“å†²åŒº
	de->inode = 0;
	bh->b_dirt = 1;
	brelse(bh);

	// è¯¥ i èŠ‚ç‚¹çš„è¿æ¥æ•°å‡ 1ï¼Œç½®å·²ä¿®æ”¹æ ‡å¿—ï¼Œæ›´æ–°æ”¹å˜æ—¶é—´ä¸ºå½“å‰æ—¶é—´
	// æœ€åé‡Šæ”¾è¯¥ i èŠ‚ç‚¹å’Œç›®å½•çš„ i èŠ‚ç‚¹ï¼Œè¿”å› 0(æˆåŠŸ)
	inode->i_nlinks--;
	inode->i_dirt = 1;
	inode->i_ctime = CURRENT_TIME;
	iput(inode);
	iput(dir);
	return 0;
}

// ç³»ç»Ÿè°ƒç”¨å‡½æ•° - ä¸ºæ–‡ä»¶å»ºç«‹ä¸€ä¸ªæ–‡ä»¶å
// ä¸ºä¸€ä¸ªå·²ç»å­˜åœ¨çš„æ–‡ä»¶åˆ›å»ºä¸€ä¸ªæ–°è¿æ¥(ä¹Ÿç§°ä¸ºç¡¬è¿æ¥ - hard link)
// å‚æ•°ï¼š
// oldname - åŸè·¯å¾„åï¼›
// newname - æ–°çš„è·¯å¾„å
// è¿”å›ï¼šè‹¥æˆåŠŸåˆ™è¿”å› 0ï¼Œå¦åˆ™è¿”å›å‡ºé”™å·
int sys_link(const char *oldname, const char *newname)
{
	struct dir_entry *de;
	struct m_inode *oldinode, *dir;
	struct buffer_head *bh;
	const char *basename;
	int namelen;

	// å–åŸæ–‡ä»¶è·¯å¾„åå¯¹åº”çš„ i èŠ‚ç‚¹ oldinode
	// å¦‚æœä¸º 0ï¼Œåˆ™è¡¨ç¤ºå‡ºé”™ï¼Œè¿”å›å‡ºé”™å·
	oldinode = namei(oldname);
	if (!oldinode)
		return -ENOENT;

	// å¦‚æœåŸè·¯å¾„åå¯¹åº”çš„æ˜¯ä¸€ä¸ªç›®å½•åï¼Œåˆ™é‡Šæ”¾è¯¥ i èŠ‚ç‚¹ï¼Œè¿”å›å‡ºé”™å·
	if (S_ISDIR(oldinode->i_mode))
	{
		iput(oldinode);
		return -EPERM;
	}

	// æŸ¥æ‰¾æ–°è·¯å¾„åçš„æœ€é¡¶å±‚ç›®å½•çš„ i èŠ‚ç‚¹ï¼Œå¹¶è¿”å›æœ€åçš„æ–‡ä»¶ååŠå…¶é•¿åº¦
	// å¦‚æœç›®å½•çš„ i èŠ‚ç‚¹æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™é‡Šæ”¾åŸè·¯å¾„åçš„ i èŠ‚ç‚¹ï¼Œè¿”å›å‡ºé”™å·
	dir = dir_namei(newname, &namelen, &basename);
	if (!dir)
	{
		iput(oldinode);
		return -EACCES;
	}

	// å¦‚æœæ–°è·¯å¾„åä¸­ä¸åŒ…æ‹¬æ–‡ä»¶åï¼Œåˆ™é‡Šæ”¾åŸè·¯å¾„å i èŠ‚ç‚¹å’Œæ–°è·¯å¾„åç›®å½•çš„ i èŠ‚ç‚¹ï¼Œè¿”å›å‡ºé”™å·
	if (!namelen)
	{
		iput(oldinode);
		iput(dir);
		return -EPERM;
	}

	// å¦‚æœæ–°è·¯å¾„åç›®å½•çš„è®¾å¤‡å·ä¸åŸè·¯å¾„åçš„è®¾å¤‡å·ä¸ä¸€æ ·ï¼Œåˆ™ä¹Ÿä¸èƒ½å»ºç«‹è¿æ¥
	// äºæ˜¯é‡Šæ”¾æ–°è·¯å¾„åç›®å½•çš„ i èŠ‚ç‚¹å’ŒåŸè·¯å¾„åçš„ i èŠ‚ç‚¹ï¼Œè¿”å›å‡ºé”™å·
	if (dir->i_dev != oldinode->i_dev)
	{
		iput(dir);
		iput(oldinode);
		return -EXDEV;
	}

	// å¦‚æœç”¨æˆ·æ²¡æœ‰åœ¨æ–°ç›®å½•ä¸­å†™çš„æƒé™ï¼Œåˆ™ä¹Ÿä¸èƒ½å»ºç«‹è¿æ¥
	// äºæ˜¯é‡Šæ”¾æ–°è·¯å¾„åç›®å½•çš„ i èŠ‚ç‚¹å’ŒåŸè·¯å¾„åçš„ i èŠ‚ç‚¹ï¼Œè¿”å›å‡ºé”™å·
	if (!permission(dir, MAY_WRITE))
	{
		iput(dir);
		iput(oldinode);
		return -EACCES;
	}

	// æŸ¥è¯¢è¯¥æ–°è·¯å¾„åæ˜¯å¦å·²ç»å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™ä¹Ÿä¸èƒ½å»ºç«‹è¿æ¥
	// äºæ˜¯é‡Šæ”¾åŒ…å«è¯¥å·²å­˜åœ¨ç›®å½•é¡¹çš„é«˜é€Ÿç¼“å†²åŒº
	// é‡Šæ”¾æ–°è·¯å¾„åç›®å½•çš„ i èŠ‚ç‚¹å’ŒåŸè·¯å¾„åçš„ i èŠ‚ç‚¹ï¼Œè¿”å›å‡ºé”™å·
	bh = find_entry(&dir, basename, namelen, &de);
	if (bh)
	{
		brelse(bh);
		iput(dir);
		iput(oldinode);
		return -EEXIST;
	}

	// åœ¨æ–°ç›®å½•ä¸­æ·»åŠ ä¸€ä¸ªç›®å½•é¡¹ï¼Œè‹¥å¤±è´¥åˆ™é‡Šæ”¾è¯¥ç›®å½•çš„ i èŠ‚ç‚¹å’ŒåŸè·¯å¾„åçš„ i èŠ‚ç‚¹ï¼Œè¿”å›å‡ºé”™å·
	bh = add_entry(dir, basename, namelen, &de);
	if (!bh)
	{
		iput(dir);
		iput(oldinode);
		return -ENOSPC;
	}

	// å¦åˆ™åˆå§‹è®¾ç½®è¯¥ç›®å½•é¡¹çš„ i èŠ‚ç‚¹å·ç­‰äºåŸè·¯å¾„åçš„ i èŠ‚ç‚¹å·
	// å¹¶ç½®åŒ…å«è¯¥æ–°æ·»ç›®å½•é¡¹çš„é«˜é€Ÿç¼“å†²åŒºå·²ä¿®æ”¹æ ‡å¿—ï¼Œé‡Šæ”¾è¯¥ç¼“å†²åŒºï¼Œé‡Šæ”¾ç›®å½•çš„ i èŠ‚ç‚¹
	de->inode = oldinode->i_num;
	bh->b_dirt = 1;
	brelse(bh);
	iput(dir);

	// å°†åŸèŠ‚ç‚¹çš„åº”ç”¨è®¡æ•°åŠ  1ï¼Œä¿®æ”¹å…¶æ”¹å˜æ—¶é—´ä¸ºå½“å‰æ—¶é—´
	// å¹¶è®¾ç½® i èŠ‚ç‚¹å·²ä¿®æ”¹æ ‡å¿—ï¼Œæœ€åé‡Šæ”¾åŸè·¯å¾„åçš„ i èŠ‚ç‚¹ï¼Œå¹¶è¿”å› 0(æˆåŠŸ)
	oldinode->i_nlinks++;
	oldinode->i_ctime = CURRENT_TIME;
	oldinode->i_dirt = 1;
	iput(oldinode);
	return 0;
}
