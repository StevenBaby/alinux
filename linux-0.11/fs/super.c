/*
 *  linux/fs/super.c
 *
 *  (C) 1991  Linus Torvalds
 */

/*
 * super.c contains code to handle the super-block tables.
 */
#include <linux/config.h>
#include <linux/sched.h>
#include <linux/kernel.h>
#include <asm/system.h>

#include <errno.h>
#include <sys/stat.h>

// å¯¹æŒ‡å®šè®¾å¤‡æ‰§è¡Œé«˜é€Ÿç¼“å†²ä¸è®¾å¤‡ä¸Šæ•°æ®çš„åŒæ­¥æ“ä½œ
int sync_dev(int dev);

// ç­‰å¾…å‡»é”®
void wait_for_keypress(void);

// set_bit() ä½¿ç”¨äº† setb æŒ‡ä»¤ï¼Œå› ä¸ºæ±‡ç¼–ç¼–è¯‘å™¨ gas ä¸èƒ½è¯†åˆ«æŒ‡ä»¤ setc
// æµ‹è¯•æŒ‡å®šä½åç§»å¤„æ¯”ç‰¹ä½çš„å€¼(0 æˆ– 1)ï¼Œå¹¶è¿”å›è¯¥æ¯”ç‰¹ä½å€¼ã€‚(åº”è¯¥å–åä¸º test_bit() æ›´å¦¥å¸–)
// å†…è”æ±‡ç¼–å®å‡½æ•°ã€‚å‚æ•° bitnr æ˜¯æ¯”ç‰¹ä½åç§»å€¼ï¼Œaddr æ˜¯æµ‹è¯•æ¯”ç‰¹ä½æ“ä½œçš„èµ·å§‹åœ°å€
// %0 - ax(__res)ï¼Œ%1 - 0ï¼Œ%2 - bitnrï¼Œ%3 - addr
#define set_bit(bitnr, addr) (                       \
	{                                                \
		register int __res;                          \
		__asm__("bt %2,%3 \n setb %%al"              \
				: "=a"(__res)                        \
				: "a"(0), "r"(bitnr), "m"(*(addr))); \
		__res;                                       \
	})

// è¶…çº§å—ç»“æ„æ•°ç»„
struct super_block super_block[NR_SUPER];

// ROOT_DEV å·²åœ¨ init/main.c ä¸­è¢«åˆå§‹åŒ–
int ROOT_DEV = 0;

// é”å®šæŒ‡å®šçš„è¶…çº§å—
static void lock_super(struct super_block *sb)
{
	// å…³ä¸­æ–­
	cli();

	// å¦‚æœè¯¥è¶…çº§å—å·²ç»ä¸Šé”ï¼Œåˆ™ç¡çœ ç­‰å¾…
	while (sb->s_lock)
		sleep_on(&(sb->s_wait));

	// ç»™è¯¥è¶…çº§å—åŠ é”ï¼ˆç½®é”å®šæ ‡å¿—ï¼‰
	sb->s_lock = 1;

	// å¼€ä¸­æ–­
	sti();
}

// å¯¹æŒ‡å®šè¶…çº§å—è§£é”ï¼ˆå¦‚æœä½¿ç”¨ ulock_super è¿™ä¸ªåç§°åˆ™æ›´å¦¥å¸–ï¼‰
static void free_super(struct super_block *sb)
{
	// å…³ä¸­æ–­
	cli();

	// å¤ä½é”å®šæ ‡å¿—
	sb->s_lock = 0;

	// å”¤é†’ç­‰å¾…è¯¥è¶…çº§å—çš„è¿›ç¨‹
	wake_up(&(sb->s_wait));

	// å¼€ä¸­æ–­
	sti();
}

// ç¡çœ ç­‰å¾…è¶…çº§å—è§£é”
static void wait_on_super(struct super_block *sb)
{
	// å…³ä¸­æ–­
	cli();

	// å¦‚æœè¶…çº§å—å·²ç»ä¸Šé”ï¼Œåˆ™ç¡çœ ç­‰å¾…
	while (sb->s_lock)
		sleep_on(&(sb->s_wait));

	// å¼€ä¸­æ–­
	sti();
}

// å–æŒ‡å®šè®¾å¤‡çš„è¶…çº§å—ï¼Œè¿”å›è¯¥è¶…çº§å—ç»“æ„æŒ‡é’ˆ
struct super_block *get_super(int dev)
{
	struct super_block *s;

	// å¦‚æœæ²¡æœ‰æŒ‡å®šè®¾å¤‡ï¼Œåˆ™è¿”å›ç©ºæŒ‡é’ˆ
	if (!dev)
		return NULL;

	// s æŒ‡å‘è¶…çº§å—æ•°ç»„å¼€å§‹å¤„ï¼Œæœç´¢æ•´ä¸ªè¶…çº§å—æ•°ç»„ï¼Œå¯»æ‰¾æŒ‡å®šè®¾å¤‡çš„è¶…çº§å—
	s = 0 + super_block;

	while (s < NR_SUPER + super_block)
		// å¦‚æœå½“å‰æœç´¢é¡¹æ˜¯æŒ‡å®šè®¾å¤‡çš„è¶…çº§å—
		// åˆ™é¦–å…ˆç­‰å¾…è¯¥è¶…çº§å—è§£é”ï¼ˆè‹¥å·²ç»è¢«å…¶å®ƒè¿›ç¨‹ä¸Šé”çš„è¯ï¼‰
		// åœ¨ç­‰å¾…æœŸé—´ï¼Œè¯¥è¶…çº§å—æœ‰å¯èƒ½è¢«å…¶å®ƒè®¾å¤‡ä½¿ç”¨
		// å› æ­¤æ­¤æ—¶éœ€å†åˆ¤æ–­ä¸€æ¬¡æ˜¯å¦æ˜¯æŒ‡å®šè®¾å¤‡çš„è¶…çº§å—
		// å¦‚æœæ˜¯åˆ™è¿”å›è¯¥è¶…çº§å—çš„æŒ‡é’ˆ
		// å¦åˆ™å°±é‡æ–°å¯¹è¶…çº§å—æ•°ç»„å†æœç´¢ä¸€é
		// å› æ­¤ s é‡åˆæŒ‡å‘è¶…çº§å—æ•°ç»„å¼€å§‹å¤„
		if (s->s_dev == dev)
		{
			wait_on_super(s);
			if (s->s_dev == dev)
				return s;
			s = 0 + super_block;
		}
		// å¦‚æœå½“å‰æœç´¢é¡¹ä¸æ˜¯ï¼Œåˆ™æ£€æŸ¥ä¸‹ä¸€é¡¹
		else
			s++;
	// å¦‚æœæ²¡æœ‰æ‰¾åˆ°æŒ‡å®šçš„è¶…çº§å—ï¼Œåˆ™è¿”å›ç©ºæŒ‡é’ˆ
	return NULL;
}

// é‡Šæ”¾æŒ‡å®šè®¾å¤‡çš„è¶…çº§å—
// é‡Šæ”¾è®¾å¤‡æ‰€ä½¿ç”¨çš„è¶…çº§å—æ•°ç»„é¡¹ï¼ˆç½®s_dev=0ï¼‰
// å¹¶é‡Šæ”¾è¯¥è®¾å¤‡ i èŠ‚ç‚¹ä½å›¾å’Œé€»è¾‘å—ä½å›¾æ‰€å ç”¨çš„é«˜é€Ÿç¼“å†²å—
// å¦‚æœè¶…çº§å—å¯¹åº”çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯æ ¹æ–‡ä»¶ç³»ç»Ÿ
// æˆ–è€…å…¶ i èŠ‚ç‚¹ä¸Šå·²ç»å®‰è£…æœ‰å…¶å®ƒçš„æ–‡ä»¶ç³»ç»Ÿï¼Œåˆ™ä¸èƒ½é‡Šæ”¾è¯¥è¶…çº§å—
void put_super(int dev)
{
	struct super_block *sb;
	/* struct m_inode * inode;*/
	int i;

	// å¦‚æœæŒ‡å®šè®¾å¤‡æ˜¯æ ¹æ–‡ä»¶ç³»ç»Ÿè®¾å¤‡ï¼Œ
	// åˆ™æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯â€œæ ¹ç³»ç»Ÿç›˜æ”¹å˜äº†ï¼Œå‡†å¤‡ç”Ÿæ­»å†³æˆ˜å§â€ï¼Œå¹¶è¿”å›
	if (dev == ROOT_DEV)
	{
		printk("root diskette changed: prepare for armageddon\n\r");
		return;
	}

	// å¦‚æœæ‰¾ä¸åˆ°æŒ‡å®šè®¾å¤‡çš„è¶…çº§å—ï¼Œåˆ™è¿”å›
	if (!(sb = get_super(dev)))
		return;

	// å¦‚æœè¯¥è¶…çº§å—æŒ‡æ˜æœ¬æ–‡ä»¶ç³»ç»Ÿ i èŠ‚ç‚¹ä¸Šå®‰è£…æœ‰å…¶å®ƒçš„æ–‡ä»¶ç³»ç»Ÿï¼Œåˆ™æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯ï¼Œè¿”å›
	if (sb->s_imount)
	{
		printk("Mounted disk changed - tssk, tssk\n\r");
		return;
	}

	// æ‰¾åˆ°æŒ‡å®šè®¾å¤‡çš„è¶…çº§å—åï¼Œé¦–å…ˆé”å®šè¯¥è¶…çº§å—
	// ç„¶åç½®è¯¥è¶…çº§å—å¯¹åº”çš„è®¾å¤‡å·å­—æ®µä¸º 0ï¼Œä¹Ÿå³ï¼Œå³å°†æ”¾å¼ƒè¯¥è¶…çº§å—
	lock_super(sb);
	sb->s_dev = 0;

	// ç„¶åé‡Šæ”¾è¯¥è®¾å¤‡ i èŠ‚ç‚¹ä½å›¾å’Œé€»è¾‘å—ä½å›¾åœ¨ç¼“å†²åŒºä¸­æ‰€å ç”¨çš„ç¼“å†²å—
	for (i = 0; i < I_MAP_SLOTS; i++)
		brelse(sb->s_imap[i]);
	for (i = 0; i < Z_MAP_SLOTS; i++)
		brelse(sb->s_zmap[i]);

	// æœ€åå¯¹è¯¥è¶…çº§å—è§£é”ï¼Œå¹¶è¿”å›
	free_super(sb);
	return;
}

// ä»è®¾å¤‡ä¸Šè¯»å–è¶…çº§å—åˆ°ç¼“å†²åŒºä¸­
// å¦‚æœè¯¥è®¾å¤‡çš„è¶…çº§å—å·²ç»åœ¨é«˜é€Ÿç¼“å†²ä¸­å¹¶ä¸”æœ‰æ•ˆï¼Œåˆ™ç›´æ¥è¿”å›è¯¥è¶…çº§å—çš„æŒ‡é’ˆ
static struct super_block *read_super(int dev)
{
	struct super_block *s;
	struct buffer_head *bh;
	int i, block;

	// å¦‚æœæ²¡æœ‰æŒ‡æ˜è®¾å¤‡ï¼Œåˆ™è¿”å›ç©ºæŒ‡é’ˆ
	if (!dev)
		return NULL;

	// é¦–å…ˆæ£€æŸ¥è¯¥è®¾å¤‡æ˜¯å¦å¯æ›´æ¢è¿‡ç›˜ç‰‡ï¼ˆä¹Ÿå³æ˜¯å¦æ˜¯è½¯ç›˜è®¾å¤‡ï¼‰
	// å¦‚æœæ›´æ¢è¿‡ç›˜ï¼Œåˆ™é«˜é€Ÿç¼“å†²åŒºæœ‰å…³è¯¥è®¾å¤‡çš„æ‰€æœ‰ç¼“å†²å—å‡å¤±æ•ˆ
	// éœ€è¦è¿›è¡Œå¤±æ•ˆå¤„ç†ï¼ˆé‡Šæ”¾åŸæ¥åŠ è½½çš„æ–‡ä»¶ç³»ç»Ÿï¼‰
	check_disk_change(dev);

	// å¦‚æœè¯¥è®¾å¤‡çš„è¶…çº§å—å·²ç»åœ¨é«˜é€Ÿç¼“å†²ä¸­ï¼Œåˆ™ç›´æ¥è¿”å›è¯¥è¶…çº§å—çš„æŒ‡é’ˆ
	if ((s = get_super(dev)))
		return s;

	// å¦åˆ™ï¼Œé¦–å…ˆåœ¨è¶…çº§å—æ•°ç»„ä¸­æ‰¾å‡ºä¸€ä¸ªç©ºé¡¹(ä¹Ÿå³å…¶s_dev = 0 çš„é¡¹)
	// å¦‚æœæ•°ç»„å·²ç»å æ»¡åˆ™è¿”å›ç©ºæŒ‡é’ˆ
	for (s = 0 + super_block;; s++)
	{
		if (s >= NR_SUPER + super_block)
			return NULL;
		if (!s->s_dev)
			break;
	}
	// æ‰¾åˆ°è¶…çº§å—ç©ºé¡¹åï¼Œå°±å°†è¯¥è¶…çº§å—ç”¨äºæŒ‡å®šè®¾å¤‡ï¼Œå¯¹è¯¥è¶…çº§å—çš„å†…å­˜é¡¹è¿›è¡Œéƒ¨åˆ†åˆå§‹åŒ–
	s->s_dev = dev;
	s->s_isup = NULL;
	s->s_imount = NULL;
	s->s_time = 0;
	s->s_rd_only = 0;
	s->s_dirt = 0;

	// ç„¶åé”å®šè¯¥è¶…çº§å—ï¼Œå¹¶ä»è®¾å¤‡ä¸Šè¯»å–è¶…çº§å—ä¿¡æ¯åˆ° bh æŒ‡å‘çš„ç¼“å†²åŒºä¸­
	// å¦‚æœè¯»è¶…çº§å—æ“ä½œå¤±è´¥ï¼Œåˆ™é‡Šæ”¾ä¸Šé¢é€‰å®šçš„è¶…çº§å—æ•°ç»„ä¸­çš„é¡¹ï¼Œå¹¶è§£é”è¯¥é¡¹ï¼Œè¿”å›ç©ºæŒ‡é’ˆé€€å‡º
	lock_super(s);
	if (!(bh = bread(dev, 1)))
	{
		s->s_dev = 0;
		free_super(s);
		return NULL;
	}

	// å°†è®¾å¤‡ä¸Šè¯»å–çš„è¶…çº§å—ä¿¡æ¯å¤åˆ¶åˆ°è¶…çº§å—æ•°ç»„ç›¸åº”é¡¹ç»“æ„ä¸­ï¼Œå¹¶é‡Šæ”¾å­˜æ”¾è¯»å–ä¿¡æ¯çš„é«˜é€Ÿç¼“å†²å—
	*((struct d_super_block *)s) =
		*((struct d_super_block *)bh->b_data);
	brelse(bh);

	// å¦‚æœè¯»å–çš„è¶…çº§å—çš„æ–‡ä»¶ç³»ç»Ÿé­”æ•°å­—æ®µå†…å®¹ä¸å¯¹ï¼Œè¯´æ˜è®¾å¤‡ä¸Šä¸æ˜¯æ­£ç¡®çš„æ–‡ä»¶ç³»ç»Ÿ
	// å› æ­¤åŒä¸Šé¢ä¸€æ ·ï¼Œé‡Šæ”¾ä¸Šé¢é€‰å®šçš„è¶…çº§å—æ•°ç»„ä¸­çš„é¡¹ï¼Œå¹¶è§£é”è¯¥é¡¹ï¼Œè¿”å›ç©ºæŒ‡é’ˆé€€å‡º
	// å¯¹äºè¯¥ç‰ˆ linux å†…æ ¸ï¼Œåªæ”¯æŒ minix æ–‡ä»¶ç³»ç»Ÿç‰ˆæœ¬ 1.0ï¼Œå…¶é­”æ•°æ˜¯ 0x137f
	if (s->s_magic != SUPER_MAGIC)
	{
		s->s_dev = 0;
		free_super(s);
		return NULL;
	}

	// ä¸‹é¢å¼€å§‹è¯»å–è®¾å¤‡ä¸Š i èŠ‚ç‚¹ä½å›¾å’Œé€»è¾‘å—ä½å›¾æ•°æ®ï¼Œé¦–å…ˆåˆå§‹åŒ–å†…å­˜è¶…çº§å—ç»“æ„ä¸­ä½å›¾ç©ºé—´
	for (i = 0; i < I_MAP_SLOTS; i++)
		s->s_imap[i] = NULL;
	for (i = 0; i < Z_MAP_SLOTS; i++)
		s->s_zmap[i] = NULL;

	// ç„¶åä»è®¾å¤‡ä¸Šè¯»å– i èŠ‚ç‚¹ä½å›¾å’Œé€»è¾‘å—ä½å›¾ä¿¡æ¯ï¼Œå¹¶å­˜æ”¾åœ¨è¶…çº§å—å¯¹åº”å­—æ®µä¸­
	block = 2;
	for (i = 0; i < s->s_imap_blocks; i++)
		if ((s->s_imap[i] = bread(dev, block)))
			block++;
		else
			break;
	for (i = 0; i < s->s_zmap_blocks; i++)
		if ((s->s_zmap[i] = bread(dev, block)))
			block++;
		else
			break;

	// å¦‚æœè¯»å‡ºçš„ä½å›¾é€»è¾‘å—æ•°ä¸ç­‰äºä½å›¾åº”è¯¥å æœ‰çš„é€»è¾‘å—æ•°
	// è¯´æ˜æ–‡ä»¶ç³»ç»Ÿä½å›¾ä¿¡æ¯æœ‰é—®é¢˜ï¼Œè¶…çº§å—åˆå§‹åŒ–å¤±è´¥
	// å› æ­¤åªèƒ½é‡Šæ”¾å‰é¢ç”³è¯·çš„æ‰€æœ‰èµ„æºï¼Œè¿”å›ç©ºæŒ‡é’ˆå¹¶é€€å‡º
	if (block != 2 + s->s_imap_blocks + s->s_zmap_blocks)
	{
		// é‡Šæ”¾ i èŠ‚ç‚¹ä½å›¾å’Œé€»è¾‘å—ä½å›¾å ç”¨çš„é«˜é€Ÿç¼“å†²åŒº
		for (i = 0; i < I_MAP_SLOTS; i++)
			brelse(s->s_imap[i]);
		for (i = 0; i < Z_MAP_SLOTS; i++)
			brelse(s->s_zmap[i]);

		// é‡Šæ”¾ä¸Šé¢é€‰å®šçš„è¶…çº§å—æ•°ç»„ä¸­çš„é¡¹ï¼Œå¹¶è§£é”è¯¥è¶…çº§å—é¡¹ï¼Œè¿”å›ç©ºæŒ‡é’ˆé€€å‡º
		s->s_dev = 0;
		free_super(s);
		return NULL;
	}

	// å¦åˆ™ä¸€åˆ‡æˆåŠŸï¼Œå¯¹äºç”³è¯·ç©ºé—² i èŠ‚ç‚¹çš„å‡½æ•°æ¥è®²
	// å¦‚æœè®¾å¤‡ä¸Šæ‰€æœ‰çš„ i èŠ‚ç‚¹å·²ç»å…¨è¢«ä½¿ç”¨ï¼Œåˆ™æŸ¥æ‰¾å‡½æ•°ä¼šè¿”å› 0 å€¼
	// å› æ­¤ 0 å· i èŠ‚ç‚¹æ˜¯ä¸èƒ½ç”¨çš„
	// æ‰€ä»¥è¿™é‡Œå°†ä½å›¾ä¸­çš„æœ€ä½ä½è®¾ç½®ä¸º 1ï¼Œä»¥é˜²æ­¢æ–‡ä»¶ç³»ç»Ÿåˆ†é… 0 å· i èŠ‚ç‚¹
	// åŒæ ·çš„é“ç†ï¼Œä¹Ÿå°†é€»è¾‘å—ä½å›¾çš„æœ€ä½ä½è®¾ç½®ä¸º 1
	s->s_imap[0]->b_data[0] |= 1;
	s->s_zmap[0]->b_data[0] |= 1;

	// è§£é”è¯¥è¶…çº§å—ï¼Œå¹¶è¿”å›è¶…çº§å—æŒ‡é’ˆ
	free_super(s);
	return s;
}

// å¸è½½æ–‡ä»¶ç³»ç»Ÿçš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°
// å‚æ•° dev_name æ˜¯è®¾å¤‡æ–‡ä»¶å
int sys_umount(char *dev_name)
{
	struct m_inode *inode;
	struct super_block *sb;
	int dev;

	// é¦–å…ˆæ ¹æ®è®¾å¤‡æ–‡ä»¶åæ‰¾åˆ°å¯¹åº”çš„ i èŠ‚ç‚¹ï¼Œå¹¶å–å…¶ä¸­çš„è®¾å¤‡å·
	if (!(inode = namei(dev_name)))
		return -ENOENT;
	dev = inode->i_zone[0];

	// å¦‚æœä¸æ˜¯å—è®¾å¤‡æ–‡ä»¶ï¼Œåˆ™é‡Šæ”¾åˆšç”³è¯·çš„ i èŠ‚ç‚¹ dev_iï¼Œè¿”å›å‡ºé”™ç 
	if (!S_ISBLK(inode->i_mode))
	{
		iput(inode);
		return -ENOTBLK;
	}

	// é‡Šæ”¾è®¾å¤‡æ–‡ä»¶åçš„ i èŠ‚ç‚¹
	iput(inode);

	// å¦‚æœè®¾å¤‡æ˜¯æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œåˆ™ä¸èƒ½è¢«å¸è½½ï¼Œè¿”å›å‡ºé”™å·
	if (dev == ROOT_DEV)
		return -EBUSY;

	// å¦‚æœå–è®¾å¤‡çš„è¶…çº§å—å¤±è´¥ï¼Œæˆ–è€…è¯¥è®¾å¤‡æ–‡ä»¶ç³»ç»Ÿæ²¡æœ‰å®‰è£…è¿‡ï¼Œåˆ™è¿”å›å‡ºé”™ç 
	if (!(sb = get_super(dev)) || !(sb->s_imount))
		return -ENOENT;

	// å¦‚æœè¶…çº§å—æ‰€æŒ‡æ˜çš„è¢«å®‰è£…åˆ°çš„ i èŠ‚ç‚¹æ²¡æœ‰ç½®ä½å…¶å®‰è£…æ ‡å¿—ï¼Œåˆ™æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
	if (!sb->s_imount->i_mount)
		printk("Mounted inode has i_mount=0\n");

	// æŸ¥æ‰¾ i èŠ‚ç‚¹è¡¨ï¼Œçœ‹æ˜¯å¦æœ‰è¿›ç¨‹åœ¨ä½¿ç”¨è¯¥è®¾å¤‡ä¸Šçš„æ–‡ä»¶ï¼Œå¦‚æœæœ‰åˆ™è¿”å›å¿™å‡ºé”™ç 
	for (inode = inode_table + 0; inode < inode_table + NR_INODE; inode++)
		if (inode->i_dev == dev && inode->i_count)
			return -EBUSY;

	// å¤ä½è¢«å®‰è£…åˆ°çš„ i èŠ‚ç‚¹çš„å®‰è£…æ ‡å¿—ï¼Œé‡Šæ”¾è¯¥ i èŠ‚ç‚¹
	sb->s_imount->i_mount = 0;
	iput(sb->s_imount);

	// ç½®è¶…çº§å—ä¸­è¢«å®‰è£… i èŠ‚ç‚¹å­—æ®µä¸ºç©ºï¼Œå¹¶é‡Šæ”¾è®¾å¤‡æ–‡ä»¶ç³»ç»Ÿçš„æ ¹ i èŠ‚ç‚¹
	// ç½®è¶…çº§å—ä¸­è¢«å®‰è£…ç³»ç»Ÿæ ¹ i èŠ‚ç‚¹æŒ‡é’ˆä¸ºç©º
	sb->s_imount = NULL;
	iput(sb->s_isup);
	sb->s_isup = NULL;

	// é‡Šæ”¾è¯¥è®¾å¤‡çš„è¶…çº§å—ä»¥åŠä½å›¾å ç”¨çš„ç¼“å†²å—
	// å¹¶å¯¹è¯¥è®¾å¤‡æ‰§è¡Œé«˜é€Ÿç¼“å†²ä¸è®¾å¤‡ä¸Šæ•°æ®çš„åŒæ­¥æ“ä½œ
	put_super(dev);
	sync_dev(dev);
	return 0;
}

// å®‰è£…æ–‡ä»¶ç³»ç»Ÿè°ƒç”¨å‡½æ•°
// å‚æ•° dev_name æ˜¯è®¾å¤‡æ–‡ä»¶åï¼Œdir_name æ˜¯å®‰è£…åˆ°çš„ç›®å½•åï¼Œrw_flag è¢«å®‰è£…æ–‡ä»¶çš„è¯»å†™æ ‡å¿—
// å°†è¢«åŠ è½½çš„åœ°æ–¹å¿…é¡»æ˜¯ä¸€ä¸ªç›®å½•åï¼Œå¹¶ä¸”å¯¹åº”çš„ i èŠ‚ç‚¹æ²¡æœ‰è¢«å…¶å®ƒç¨‹åºå ç”¨
int sys_mount(char *dev_name, char *dir_name, int rw_flag)
{
	struct m_inode *dev_i, *dir_i;
	struct super_block *sb;
	int dev;

	// é¦–å…ˆæ ¹æ®è®¾å¤‡æ–‡ä»¶åæ‰¾åˆ°å¯¹åº”çš„ i èŠ‚ç‚¹ï¼Œå¹¶å–å…¶ä¸­çš„è®¾å¤‡å·
	// å¯¹äºå—ç‰¹æ®Šè®¾å¤‡æ–‡ä»¶ï¼Œè®¾å¤‡å·åœ¨ i èŠ‚ç‚¹çš„ i_zone[0] ä¸­
	if (!(dev_i = namei(dev_name)))
		return -ENOENT;
	dev = dev_i->i_zone[0];

	// å¦‚æœä¸æ˜¯å—è®¾å¤‡æ–‡ä»¶ï¼Œåˆ™é‡Šæ”¾åˆšå–å¾—çš„ i èŠ‚ç‚¹ dev_iï¼Œè¿”å›å‡ºé”™ç 
	if (!S_ISBLK(dev_i->i_mode))
	{
		iput(dev_i);
		return -EPERM;
	}

	// é‡Šæ”¾è¯¥è®¾å¤‡æ–‡ä»¶çš„ i èŠ‚ç‚¹ dev_i
	iput(dev_i);

	// æ ¹æ®ç»™å®šçš„ç›®å½•æ–‡ä»¶åæ‰¾åˆ°å¯¹åº”çš„ i èŠ‚ç‚¹ dir_i
	if (!(dir_i = namei(dir_name)))
		return -ENOENT;

	// å¦‚æœè¯¥ i èŠ‚ç‚¹çš„å¼•ç”¨è®¡æ•°ä¸ä¸º 1ï¼ˆä»…åœ¨è¿™é‡Œå¼•ç”¨ï¼‰
	// æˆ–è€…è¯¥ i èŠ‚ç‚¹çš„èŠ‚ç‚¹å·æ˜¯æ ¹æ–‡ä»¶ç³»ç»Ÿçš„èŠ‚ç‚¹å· 1ï¼Œåˆ™é‡Šæ”¾è¯¥ i èŠ‚ç‚¹ï¼Œè¿”å›å‡ºé”™ç 
	if (dir_i->i_count != 1 || dir_i->i_num == ROOT_INO)
	{
		iput(dir_i);
		return -EBUSY;
	}

	// å¦‚æœè¯¥èŠ‚ç‚¹ä¸æ˜¯ä¸€ä¸ªç›®å½•æ–‡ä»¶èŠ‚ç‚¹ï¼Œåˆ™ä¹Ÿé‡Šæ”¾è¯¥ i èŠ‚ç‚¹ï¼Œè¿”å›å‡ºé”™ç 
	if (!S_ISDIR(dir_i->i_mode))
	{
		iput(dir_i);
		return -EPERM;
	}

	// è¯»å–å°†å®‰è£…æ–‡ä»¶ç³»ç»Ÿçš„è¶…çº§å—ï¼Œå¦‚æœå¤±è´¥åˆ™ä¹Ÿé‡Šæ”¾è¯¥ i èŠ‚ç‚¹ï¼Œè¿”å›å‡ºé”™ç 
	if (!(sb = read_super(dev)))
	{
		iput(dir_i);
		return -EBUSY;
	}

	// å¦‚æœå°†è¦è¢«å®‰è£…çš„æ–‡ä»¶ç³»ç»Ÿå·²ç»å®‰è£…åœ¨å…¶å®ƒåœ°æ–¹ï¼Œåˆ™é‡Šæ”¾è¯¥ i èŠ‚ç‚¹ï¼Œè¿”å›å‡ºé”™ç 
	if (sb->s_imount)
	{
		iput(dir_i);
		return -EBUSY;
	}

	// å¦‚æœå°†è¦å®‰è£…åˆ°çš„ i èŠ‚ç‚¹å·²ç»å®‰è£…äº†æ–‡ä»¶ç³»ç»Ÿ(å®‰è£…æ ‡å¿—å·²ç»ç½®ä½)ï¼Œåˆ™é‡Šæ”¾è¯¥ i èŠ‚ç‚¹ï¼Œè¿”å›å‡ºé”™ç 
	if (dir_i->i_mount)
	{
		iput(dir_i);
		return -EPERM;
	}

	// è¢«å®‰è£…æ–‡ä»¶ç³»ç»Ÿè¶…çº§å—çš„â€œè¢«å®‰è£…åˆ° i èŠ‚ç‚¹â€å­—æ®µæŒ‡å‘å®‰è£…åˆ°çš„ç›®å½•åçš„ i èŠ‚ç‚¹
	sb->s_imount = dir_i;

	// è®¾ç½®å®‰è£…ä½ç½® i èŠ‚ç‚¹çš„å®‰è£…æ ‡å¿—å’ŒèŠ‚ç‚¹å·²ä¿®æ”¹æ ‡å¿—
	dir_i->i_mount = 1;
	dir_i->i_dirt = 1; // æ³¨æ„ï¼è¿™é‡Œæ²¡æœ‰iput(dir_i)
	return 0;		   // è¿™å°†åœ¨ umount å†…æ“ä½œ
}

// å®‰è£…æ ¹æ–‡ä»¶ç³»ç»Ÿ
// è¯¥å‡½æ•°æ˜¯åœ¨ç³»ç»Ÿå¼€æœºåˆå§‹åŒ–è®¾ç½®æ—¶ sys_setup() è°ƒç”¨çš„
void mount_root(void)
{
	int i, free;
	struct super_block *p;
	struct m_inode *mi;

	// å¦‚æœç£ç›˜ i èŠ‚ç‚¹ç»“æ„ä¸æ˜¯ 32 ä¸ªå­—èŠ‚ï¼Œåˆ™å‡ºé”™ï¼Œæ­»æœº
	// è¯¥åˆ¤æ–­æ˜¯ç”¨äºé˜²æ­¢ä¿®æ”¹æºä»£ç æ—¶çš„ä¸ä¸€è‡´æ€§
	if (32 != sizeof(struct d_inode))
		panic("bad i-node size");

	// åˆå§‹åŒ–æ–‡ä»¶è¡¨æ•°ç»„ï¼ˆå…± 64 é¡¹ï¼Œä¹Ÿå³ç³»ç»ŸåŒæ—¶åªèƒ½æ‰“å¼€ 64 ä¸ªæ–‡ä»¶ï¼‰
	// å°†æ‰€æœ‰æ–‡ä»¶ç»“æ„ä¸­çš„å¼•ç”¨è®¡æ•°è®¾ç½®ä¸º0
	// [??ä¸ºä»€ä¹ˆæ”¾åœ¨è¿™é‡Œåˆå§‹åŒ–ï¼Ÿå› ä¸ºæ ¹æ–‡ä»¶ç³»ç»Ÿåœ¨è¿™é‡ŒåŠ è½½ ğŸ˜Š]
	for (i = 0; i < NR_FILE; i++)
		file_table[i].f_count = 0;

	// å¦‚æœæ ¹æ–‡ä»¶ç³»ç»Ÿæ‰€åœ¨è®¾å¤‡æ˜¯è½¯ç›˜çš„è¯
	// å°±æç¤ºâ€œæ’å…¥æ ¹æ–‡ä»¶ç³»ç»Ÿç›˜ï¼Œå¹¶æŒ‰å›è½¦é”®â€ï¼Œå¹¶ç­‰å¾…æŒ‰é”®
	if (MAJOR(ROOT_DEV) == 2)
	{
		printk("Insert root floppy and press ENTER");
		wait_for_keypress();
	}

	// åˆå§‹åŒ–è¶…çº§å—æ•°ç»„
	for (p = &super_block[0]; p < &super_block[NR_SUPER]; p++)
	{
		p->s_dev = 0;
		p->s_lock = 0;
		p->s_wait = NULL;
	}

	// å¦‚æœè¯»æ ¹è®¾å¤‡ä¸Šè¶…çº§å—å¤±è´¥ï¼Œåˆ™æ˜¾ç¤ºä¿¡æ¯ï¼Œå¹¶æ­»æœº
	if (!(p = read_super(ROOT_DEV)))
		panic("Unable to mount root");

	//ä»è®¾å¤‡ä¸Šè¯»å–æ–‡ä»¶ç³»ç»Ÿçš„æ ¹ i èŠ‚ç‚¹(1)ï¼Œå¦‚æœå¤±è´¥åˆ™æ˜¾ç¤ºå‡ºé”™ä¿¡æ¯ï¼Œæ­»æœº
	if (!(mi = iget(ROOT_DEV, ROOT_INO)))
		panic("Unable to read root i-node");

	// è¯¥ i èŠ‚ç‚¹å¼•ç”¨æ¬¡æ•°é€’å¢ 3 æ¬¡ã€‚å› ä¸ºä¸‹é¢ä¹Ÿå¼•ç”¨äº†è¯¥ i èŠ‚ç‚¹
	mi->i_count += 3; // æ³¨æ„ï¼ä»é€»è¾‘ä¸Šè®²ï¼Œå®ƒå·²è¢«å¼•ç”¨äº† 4 æ¬¡ï¼Œè€Œä¸æ˜¯ 1 æ¬¡

	// ç½®è¯¥è¶…çº§å—çš„è¢«å®‰è£…æ–‡ä»¶ç³»ç»Ÿ i èŠ‚ç‚¹å’Œè¢«å®‰è£…åˆ°çš„ i èŠ‚ç‚¹ä¸ºè¯¥ i èŠ‚ç‚¹
	p->s_isup = p->s_imount = mi;

	// è®¾ç½®å½“å‰è¿›ç¨‹çš„å½“å‰å·¥ä½œç›®å½•å’Œæ ¹ç›®å½• i èŠ‚ç‚¹ï¼Œæ­¤æ—¶å½“å‰è¿›ç¨‹æ˜¯ 1 å·è¿›ç¨‹
	current->pwd = mi;
	current->root = mi;

	// ç»Ÿè®¡è¯¥è®¾å¤‡ä¸Šç©ºé—²å—æ•°ï¼Œé¦–å…ˆä»¤ i ç­‰äºè¶…çº§å—ä¸­è¡¨æ˜çš„è®¾å¤‡é€»è¾‘å—æ€»æ•°
	free = 0;
	i = p->s_nzones;

	// ç„¶åæ ¹æ®é€»è¾‘å—ä½å›¾ä¸­ç›¸åº”æ¯”ç‰¹ä½çš„å ç”¨æƒ…å†µç»Ÿè®¡å‡ºç©ºé—²å—æ•°
	// è¿™é‡Œå®å‡½æ•° set_bit() åªæ˜¯åœ¨æµ‹è¯•æ¯”ç‰¹ä½ï¼Œè€Œéè®¾ç½®æ¯”ç‰¹ä½
	// "i&8191"ç”¨äºå–å¾— i èŠ‚ç‚¹å·åœ¨å½“å‰å—ä¸­çš„åç§»å€¼
	// "i>>13"æ˜¯å°† i é™¤ä»¥8192ï¼Œä¹Ÿå³é™¤ä¸€ä¸ªç£ç›˜å—åŒ…å«çš„æ¯”ç‰¹ä½æ•°
	while (--i >= 0)
		if (!set_bit(i & 8191, p->s_zmap[i >> 13]->b_data))
			free++;

	// æ˜¾ç¤ºè®¾å¤‡ä¸Šç©ºé—²é€»è¾‘å—æ•°/é€»è¾‘å—æ€»æ•°
	printk("%d/%d free blocks\n\r", free, p->s_nzones);

	// ç»Ÿè®¡è®¾å¤‡ä¸Šç©ºé—² i èŠ‚ç‚¹æ•°
	// é¦–å…ˆä»¤ i ç­‰äºè¶…çº§å—ä¸­è¡¨æ˜çš„è®¾å¤‡ä¸Š i èŠ‚ç‚¹æ€»æ•°+1
	// åŠ  1 æ˜¯å°† 0 èŠ‚ç‚¹ä¹Ÿç»Ÿè®¡è¿›å»
	free = 0;
	i = p->s_ninodes + 1;

	// ç„¶åæ ¹æ® i èŠ‚ç‚¹ä½å›¾ä¸­ç›¸åº”æ¯”ç‰¹ä½çš„å ç”¨æƒ…å†µè®¡ç®—å‡ºç©ºé—² i èŠ‚ç‚¹æ•°
	while (--i >= 0)
		if (!set_bit(i & 8191, p->s_imap[i >> 13]->b_data))
			free++;

	// æ˜¾ç¤ºè®¾å¤‡ä¸Šå¯ç”¨çš„ç©ºé—² i èŠ‚ç‚¹æ•°/i èŠ‚ç‚¹æ€»æ•°
	printk("%d/%d free inodes\n\r", free, p->s_ninodes);
}
